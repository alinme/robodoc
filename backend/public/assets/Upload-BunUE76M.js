import{d as ve,r as h,i as J,w as he,c as t,a as e,j as W,v as ae,k as Z,l as X,F as j,b as G,e as Q,t as u,h as s,f as S,m as _e,n as re,p as ie,o as $e,q as ce,s as fe,u as Re,x as Fe,y as Ne}from"./index-D6DdudHB.js";import{_ as Ie}from"./FileUpload.vue_vue_type_script_setup_true_lang-BaW8ujYT.js";import{v as Ce}from"./phoneValidator-nfOHmQze.js";import De from"./ProtocolCheck-C4m_Bi3o.js";import{u as Ue}from"./contacts-IDtDDakD.js";import{u as Ee}from"./groups-BJ29z54-.js";import"./xlsx-DrgRuPKf.js";const Ve={class:"space-y-4"},Be={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Te=["value"],ze=["value"],Le=["value"],Ae=["value"],je=["value"],Ge={class:"flex justify-end"},He=["disabled"],Ke=ve({__name:"ColumnMapper",props:{headers:{},mapping:{}},emits:["update:mapping","mapping-saved"],setup(M,{emit:R}){const B=M,O=R,_=h({...B.mapping}),E=J(()=>_.value.name&&_.value.name_column&&_.value.phone_column);he(()=>B.mapping,C=>{_.value={...C}},{deep:!0});function $(){O("update:mapping",{..._.value})}async function T(){var C,a;if(E.value)try{await Q.post("/api/upload/mappings",_.value),alert("Mapping saved successfully!"),O("mapping-saved")}catch(r){alert("Error saving mapping: "+(((a=(C=r.response)==null?void 0:C.data)==null?void 0:a.error)||r.message))}}return(C,a)=>(s(),t("div",Ve,[e("div",null,[a[6]||(a[6]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Mapping Name (for saving)",-1)),W(e("input",{type:"text","onUpdate:modelValue":a[0]||(a[0]=r=>_.value.name=r),placeholder:"e.g., School Contacts Template",class:"w-full border border-gray-300 rounded-md px-3 py-2"},null,512),[[ae,_.value.name]])]),e("div",Be,[e("div",null,[a[8]||(a[8]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[Z(" Name Column "),e("span",{class:"text-red-500"},"*")],-1)),W(e("select",{"onUpdate:modelValue":a[1]||(a[1]=r=>_.value.name_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[7]||(a[7]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,Te))),128))],544),[[X,_.value.name_column]])]),e("div",null,[a[10]||(a[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[Z(" Phone Column "),e("span",{class:"text-red-500"},"*")],-1)),W(e("select",{"onUpdate:modelValue":a[2]||(a[2]=r=>_.value.phone_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[9]||(a[9]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,ze))),128))],544),[[X,_.value.phone_column]])]),e("div",null,[a[12]||(a[12]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Group Column (optional)",-1)),W(e("select",{"onUpdate:modelValue":a[3]||(a[3]=r=>_.value.group_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[11]||(a[11]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,Le))),128))],544),[[X,_.value.group_column]])]),e("div",null,[a[14]||(a[14]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Email Column (optional)",-1)),W(e("select",{"onUpdate:modelValue":a[4]||(a[4]=r=>_.value.email_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[13]||(a[13]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,Ae))),128))],544),[[X,_.value.email_column]])]),e("div",null,[a[16]||(a[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Business/Institution Column (optional)",-1)),W(e("select",{"onUpdate:modelValue":a[5]||(a[5]=r=>_.value.business_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[15]||(a[15]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,je))),128))],544),[[X,_.value.business_column]])])]),e("div",Ge,[e("button",{onClick:T,disabled:!E.value,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"}," Save Mapping ",8,He)])]))}}),We={class:"space-y-4"},Oe={key:0,class:"text-sm text-gray-500 italic"},qe={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},Qe=["onUpdate:modelValue"],Je=["value"],Xe=["onUpdate:modelValue"],Ye={key:0},Ze=["onUpdate:modelValue"],et={class:"flex items-end"},tt=["onClick"],st={class:"mt-2 text-xs text-gray-500"},lt=ve({__name:"RuleBuilder",props:{headers:{},rules:{}},emits:["update:rules"],setup(M,{emit:R}){const B=M,O=R,_=h([]);he(()=>B.rules,a=>{_.value=a.length>0?[...a]:[]},{deep:!0,immediate:!0});function E(){_.value.push({column_name:"",operator:"not_empty",value:null,is_active:!0}),T()}function $(a){_.value.splice(a,1),T()}function T(){O("update:rules",_.value)}function C(a){return{not_empty:"has a value",exists:"exists",empty:"is empty",equals:"equals",contains:"contains",not_contains:"does not contain"}[a]||a}return(a,r)=>(s(),t("div",We,[e("div",{class:"flex justify-between items-center"},[r[0]||(r[0]=e("p",{class:"text-sm text-gray-600"},"Add rules to filter which contacts to import",-1)),e("button",{onClick:E,class:"px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 cursor-pointer"}," + Add Rule ")]),_.value.length===0?(s(),t("div",Oe," No rules added. All contacts will be imported. ")):S("",!0),(s(!0),t(j,null,G(_.value,(p,m)=>(s(),t("div",{key:m,class:"border border-gray-200 rounded-lg p-4"},[e("div",qe,[e("div",null,[r[2]||(r[2]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Column",-1)),W(e("select",{"onUpdate:modelValue":b=>p.column_name=b,class:"w-full border border-gray-300 rounded-md px-2 py-1 text-sm",onChange:T},[r[1]||(r[1]=e("option",{value:""},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,b=>(s(),t("option",{key:b,value:b},u(b),9,Je))),128))],40,Qe),[[X,p.column_name]])]),e("div",null,[r[4]||(r[4]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Operator",-1)),W(e("select",{"onUpdate:modelValue":b=>p.operator=b,class:"w-full border border-gray-300 rounded-md px-2 py-1 text-sm",onChange:T},[...r[3]||(r[3]=[_e('<option value="not_empty">Not Empty (has value)</option><option value="exists">Exists</option><option value="empty">Empty (no value)</option><option value="equals">Equals</option><option value="contains">Contains</option><option value="not_contains">Does Not Contain</option>',6)])],40,Xe),[[X,p.operator]])]),p.operator==="equals"||p.operator==="contains"||p.operator==="not_contains"?(s(),t("div",Ye,[r[5]||(r[5]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Value",-1)),W(e("input",{type:"text","onUpdate:modelValue":b=>p.value=b,placeholder:"Enter value",class:"w-full border border-gray-300 rounded-md px-2 py-1 text-sm",onInput:T},null,40,Ze),[[ae,p.value]])])):S("",!0),e("div",et,[e("button",{onClick:b=>$(m),class:"px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 cursor-pointer"}," Remove ",8,tt)])]),e("div",st,' Example: "'+u(p.column_name||"Column")+" "+u(C(p.operator))+" "+u(p.value||"value")+'" ',1)]))),128))]))}}),ot={class:"space-y-4"},nt={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},at={class:"grid grid-cols-2 md:grid-cols-5 gap-4 text-sm"},rt={class:"text-2xl font-bold text-blue-900"},ut={class:"text-2xl font-bold text-green-900"},dt={class:"text-2xl font-bold text-yellow-900"},it={class:"text-2xl font-bold text-orange-900"},ct={class:"text-2xl font-bold text-red-900"},pt={class:"bg-white border rounded-lg overflow-hidden"},mt={class:"p-4 border-b bg-gray-50 flex items-center justify-between"},vt={class:"flex items-center gap-4"},gt={class:"text-sm text-gray-600"},ft={class:"overflow-x-auto",style:{"max-height":"600px","overflow-y":"auto"}},xt={class:"min-w-full divide-y divide-gray-200 text-sm"},yt={class:"bg-gray-50 sticky top-0 z-10"},bt={class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-12"},ht=["checked"],wt={class:"bg-white divide-y divide-gray-200"},_t={class:"px-3 py-2"},$t=["checked","onChange","disabled"],kt={class:"px-3 py-2"},Ct={class:"px-3 py-2"},It=["onUpdate:modelValue","onBlur","onKeyup"],St=["onDblclick"],Mt={class:"px-3 py-2"},Pt=["onUpdate:modelValue","onBlur","onKeyup"],Rt=["onDblclick"],Ft={key:2,class:"text-xs text-yellow-700 mt-1"},Nt={key:3,class:"text-xs text-red-600 mt-1"},Dt={class:"px-3 py-2"},Ut=["onUpdate:modelValue","onBlur","onKeyup"],Et=["onDblclick"],Vt={key:2,class:"text-xs text-red-600 mt-1"},Bt={class:"px-3 py-2"},Tt=["onUpdate:modelValue","onBlur","onKeyup"],zt=["onDblclick"],Lt={class:"px-3 py-2"},At={key:0,class:"text-xs"},jt={key:1,class:"text-green-600 text-xs"},Gt={class:"px-3 py-2"},Ht={class:"flex flex-col gap-1"},Kt=["onClick"],Wt=["onClick"],Ot=["onClick"],qt={class:"flex justify-between items-center flex-wrap gap-4"},Qt={class:"text-sm text-gray-600 space-y-1 flex-1"},Jt={key:0,class:"text-red-600 font-medium"},Xt={key:1,class:"text-yellow-600 font-medium"},Yt={key:2,class:"text-green-600"},Zt={key:3,class:"text-blue-600"},es={key:4,class:"text-orange-600"},ts={class:"flex gap-2"},ss=["disabled"],ls=ve({__name:"ImportPreview",props:{preview:{},stats:{}},emits:["proceed","cancel"],setup(M,{emit:R}){const B=M,O=R,_=h(""),E=h("all"),$=h(null);function T(n){$.value=n}function C(n){!n.name||!n.name.trim()?(n.issues.some(d=>d.includes("Missing name"))||n.issues.push("Missing name"),n.canImport=!1):(n.issues=n.issues.filter(d=>d!=="Missing name"),n.issues.length===0&&n.phone&&n.phone.trim()&&(n.canImport=!0)),$.value=null}function a(n){if(n.phoneError=null,!n.phone||!n.phone.trim()){n.phoneError="Phone is required",n.canImport=!1,n.issues.some(d=>d.includes("Missing phone"))||n.issues.push("Missing phone"),$.value=null;return}try{const d=Ce(n.phone.trim());if(d.valid){const x=n.phone;n.phone=d.formatted,n.issues=n.issues.filter(z=>!z.toLowerCase().includes("phone")&&!z.toLowerCase().includes("invalid phone")&&!z.toLowerCase().includes("missing phone")),(x!==n.phone||n.status==="duplicate"||n.status==="duplicate_in_file")&&(n.status="new",n.existingContact=null,n.issues=n.issues.filter(z=>!z.includes("already exists")&&!z.includes("Duplicate phone"))),n.name&&n.name.trim()&&n.issues.length===0&&(n.canImport=!0)}else n.phoneError=d.error||"Invalid phone format",n.canImport=!1,n.issues.some(x=>x.includes("Invalid phone number"))||n.issues.push("Invalid phone number")}catch{n.phoneError="Error validating phone"}$.value=null}function r(n){n.emailError=null,n.email&&n.email.trim()&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.email.trim())?n.issues=n.issues.filter(x=>x!=="Invalid email format"):(n.emailError="Invalid email format",n.issues.some(x=>x.includes("Invalid email format"))||n.issues.push("Invalid email format"))),$.value=null}const p=J(()=>{let n=[...B.preview];if(E.value!=="all"&&(E.value==="with_issues"?n=n.filter(d=>d.issues.length>0):E.value==="cannot_import"?n=n.filter(d=>!d.canImport):n=n.filter(d=>d.status===E.value)),_.value){const d=_.value.toLowerCase();n=n.filter(x=>{var z,P,te,ee;return((z=x.name)==null?void 0:z.toLowerCase().includes(d))||((P=x.phone)==null?void 0:P.toLowerCase().includes(d))||((te=x.email)==null?void 0:te.toLowerCase().includes(d))||((ee=x.business)==null?void 0:ee.toLowerCase().includes(d))})}return n}),m=J(()=>p.value.length>0&&p.value.every(n=>n.selected!==!1&&n.canImport)),b=J(()=>B.preview.filter(n=>n.selected!==!1&&n.canImport).length);function H(){const n=!m.value;p.value.forEach(d=>{d.canImport&&(d.selected=n)})}function F(n){const d=[];n.name!==n.existingContact.name&&d.push(`Name: "${n.existingContact.name}" → "${n.name}"`),n.email&&n.email!==n.existingContact.email&&d.push(`Email: "${n.existingContact.email||"none"}" → "${n.email}"`),n.business&&n.business!==n.existingContact.business&&d.push(`Business: "${n.existingContact.business||"none"}" → "${n.business}"`);const x=`Merge "${n.name}" with existing contact "${n.existingContact.name}"?

`+(d.length>0?`Changes:
${d.join(`
`)}

`:"")+"The existing contact will be updated with the new data.";confirm(x)&&(n.mergeAction="update",n.mergeTargetId=n.existingContact.id,n.status="merged",n.issues=n.issues.filter(z=>!z.includes("already exists")),n.canImport=!0)}function U(n){confirm(`Remove duplicate contact "${n.name}" from import?`)&&(n.selected=!1)}function V(n){const d=prompt(`Change phone number for "${n.name}" to make it a new contact:

Current: ${n.phone}
Existing contact: ${n.existingContact.name} (${n.existingContact.phone})

Enter new phone number:`,n.phone);if(d&&d.trim()&&d!==n.phone){const x=Ce(d.trim());x.valid?(n.phone=x.formatted,n.status="new",n.existingContact=null,n.issues=n.issues.filter(z=>!z.includes("already exists")),n.canImport=!0):alert(`Invalid phone number: ${x.error}`)}}function K(){const n=B.preview.filter(d=>d.selected!==!1&&d.canImport).map(d=>({name:d.name,phone:d.phone,email:d.email||null,business:d.business||null,group:d.group||null,rawData:d.rawData,mergeAction:d.mergeAction,mergeTargetId:d.mergeTargetId}));O("proceed",n)}return(n,d)=>(s(),t("div",ot,[e("div",nt,[d[12]||(d[12]=e("h4",{class:"font-semibold text-blue-900 mb-2"},"Import Preview",-1)),e("div",at,[e("div",null,[d[7]||(d[7]=e("div",{class:"text-blue-700 font-medium"},"Total",-1)),e("div",rt,u(M.stats.total),1)]),e("div",null,[d[8]||(d[8]=e("div",{class:"text-green-700 font-medium"},"New",-1)),e("div",ut,u(M.stats.new),1)]),e("div",null,[d[9]||(d[9]=e("div",{class:"text-yellow-700 font-medium"},"Duplicates",-1)),e("div",dt,u(M.stats.duplicate),1)]),e("div",null,[d[10]||(d[10]=e("div",{class:"text-orange-700 font-medium"},"Issues",-1)),e("div",it,u(M.stats.with_issues),1)]),e("div",null,[d[11]||(d[11]=e("div",{class:"text-red-700 font-medium"},"Cannot Import",-1)),e("div",ct,u(M.stats.cannot_import),1)])])]),e("div",pt,[e("div",mt,[e("div",vt,[W(e("input",{type:"text","onUpdate:modelValue":d[0]||(d[0]=x=>_.value=x),placeholder:"Search contacts...",class:"border rounded px-3 py-1 text-sm"},null,512),[[ae,_.value]]),W(e("select",{"onUpdate:modelValue":d[1]||(d[1]=x=>E.value=x),class:"border rounded px-3 py-1 text-sm"},[...d[13]||(d[13]=[_e('<option value="all">All Status</option><option value="new">New</option><option value="duplicate">Duplicates</option><option value="duplicate_in_file">Duplicates in File</option><option value="with_issues">With Issues</option><option value="cannot_import">Cannot Import</option>',6)])],512),[[X,E.value]])]),e("div",gt," Showing "+u(p.value.length)+" of "+u(M.preview.length),1)]),e("div",ft,[e("table",xt,[e("thead",yt,[e("tr",null,[e("th",bt,[e("input",{type:"checkbox",checked:m.value,onChange:H,class:"rounded"},null,40,ht)]),d[14]||(d[14]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Status",-1)),d[15]||(d[15]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Name",-1)),d[16]||(d[16]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Phone",-1)),d[17]||(d[17]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Email",-1)),d[18]||(d[18]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Business",-1)),d[19]||(d[19]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Issues",-1)),d[20]||(d[20]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Actions",-1))])]),e("tbody",wt,[(s(!0),t(j,null,G(p.value,(x,z)=>(s(),t("tr",{key:z,class:re({"bg-red-50":!x.canImport,"bg-yellow-50":x.status==="duplicate"||x.status==="duplicate_in_file","bg-green-50":x.status==="new"&&x.canImport&&x.issues.length===0})},[e("td",_t,[e("input",{type:"checkbox",checked:x.selected!==!1,onChange:P=>x.selected=P.target.checked,disabled:!x.canImport,class:"rounded"},null,40,$t)]),e("td",kt,[e("span",{class:re(["px-2 py-1 rounded text-xs font-medium",x.status==="new"?"bg-green-100 text-green-800":x.status==="duplicate"?"bg-yellow-100 text-yellow-800":x.status==="duplicate_in_file"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800"])},u(x.status==="new"?"New":x.status==="duplicate"?"Duplicate":x.status==="duplicate_in_file"?"Dup in File":"Issue"),3)]),e("td",Ct,[$.value===z?W((s(),t("input",{key:0,"onUpdate:modelValue":P=>x.name=P,class:"w-full border rounded px-2 py-1 text-xs",onBlur:P=>C(x),onKeyup:[ie(P=>C(x),["enter"]),d[2]||(d[2]=ie(P=>$.value=null,["escape"]))]},null,40,It)),[[ae,x.name]]):(s(),t("span",{key:1,onDblclick:P=>T(z),class:"cursor-pointer hover:bg-gray-100 px-1 rounded"},u(x.name||"-"),41,St))]),e("td",Mt,[$.value===z?W((s(),t("input",{key:0,"onUpdate:modelValue":P=>x.phone=P,class:"w-full border rounded px-2 py-1 text-xs",onBlur:P=>a(x),onKeyup:[ie(P=>a(x),["enter"]),d[3]||(d[3]=ie(P=>$.value=null,["escape"]))]},null,40,Pt)),[[ae,x.phone]]):(s(),t("span",{key:1,onDblclick:P=>T(z),class:"cursor-pointer hover:bg-gray-100 px-1 rounded"},u(x.phone||"-"),41,Rt)),x.existingContact?(s(),t("div",Ft," Exists: "+u(x.existingContact.name)+" ("+u(x.existingContact.phone)+") ",1)):S("",!0),x.phoneError?(s(),t("div",Nt,u(x.phoneError),1)):S("",!0)]),e("td",Dt,[$.value===z?W((s(),t("input",{key:0,"onUpdate:modelValue":P=>x.email=P,class:"w-full border rounded px-2 py-1 text-xs",onBlur:P=>r(x),onKeyup:[ie(P=>r(x),["enter"]),d[4]||(d[4]=ie(P=>$.value=null,["escape"]))]},null,40,Ut)),[[ae,x.email]]):(s(),t("span",{key:1,onDblclick:P=>T(z),class:"cursor-pointer hover:bg-gray-100 px-1 rounded"},u(x.email||"-"),41,Et)),x.emailError?(s(),t("div",Vt,u(x.emailError),1)):S("",!0)]),e("td",Bt,[$.value===z?W((s(),t("input",{key:0,"onUpdate:modelValue":P=>x.business=P,class:"w-full border rounded px-2 py-1 text-xs",onBlur:P=>C(x),onKeyup:[ie(P=>C(x),["enter"]),d[5]||(d[5]=ie(P=>$.value=null,["escape"]))]},null,40,Tt)),[[ae,x.business]]):(s(),t("span",{key:1,onDblclick:P=>T(z),class:"cursor-pointer hover:bg-gray-100 px-1 rounded"},u(x.business||"-"),41,zt))]),e("td",Lt,[x.issues.length>0?(s(),t("div",At,[(s(!0),t(j,null,G(x.issues,(P,te)=>(s(),t("div",{key:te,class:"text-red-600"}," • "+u(P),1))),128))])):(s(),t("span",jt,"✓ OK"))]),e("td",Gt,[e("div",Ht,[x.status==="duplicate"&&x.existingContact?(s(),t("button",{key:0,onClick:P=>F(x),class:"text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"}," Merge ",8,Kt)):S("",!0),x.status==="duplicate"&&x.existingContact?(s(),t("button",{key:1,onClick:P=>V(x),class:"text-xs px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700"}," Change Phone ",8,Wt)):S("",!0),x.status==="duplicate_in_file"?(s(),t("button",{key:2,onClick:P=>U(x),class:"text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700"}," Remove ",8,Ot)):S("",!0)])])],2))),128))])])])]),e("div",qt,[e("div",Qt,[M.stats.cannot_import>0?(s(),t("div",Jt," ⚠ "+u(M.stats.cannot_import)+" contact(s) cannot be imported. Please fix them before proceeding. ",1)):S("",!0),b.value===0?(s(),t("div",Xt," ⚠ No contacts selected. Please select at least one contact to import. ")):M.stats.cannot_import===0?(s(),t("div",Yt," ✓ "+u(b.value)+" contact(s) ready to import ",1)):S("",!0),M.stats.duplicate>0?(s(),t("div",Zt," ℹ "+u(M.stats.duplicate)+' duplicate(s) found. Use "Merge" or "Change Phone" to handle them. ',1)):S("",!0),M.stats.duplicate_in_file>0?(s(),t("div",es," ℹ "+u(M.stats.duplicate_in_file)+' duplicate(s) within file. Use "Remove" to exclude them. ',1)):S("",!0)]),e("div",ts,[e("button",{onClick:d[6]||(d[6]=x=>n.$emit("cancel")),class:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"}," Cancel "),e("button",{onClick:K,disabled:b.value===0||M.stats.cannot_import>0,class:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}," Proceed with Import ("+u(b.value)+" selected) ",9,ss)])])]))}}),os={class:"space-y-4"},ns={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},as=["value"],rs=["value"],us=["value"],ds={class:"flex justify-end"},is=["disabled"],cs=ve({__name:"CentralizatorMapper",props:{headers:{},mapping:{}},emits:["update:mapping","mapping-saved"],setup(M,{emit:R}){const B=M,O=R,_=h({...B.mapping}),E=J(()=>_.value.name&&_.value.school_name_column&&_.value.address_column);he(()=>B.mapping,C=>{_.value={...C}},{deep:!0});function $(){O("update:mapping",{..._.value})}async function T(){var C,a;if(E.value)try{await Q.post("/api/centralizator/mappings",_.value),alert("Mapping saved successfully!"),O("mapping-saved")}catch(r){alert("Error saving mapping: "+(((a=(C=r.response)==null?void 0:C.data)==null?void 0:a.error)||r.message))}}return(C,a)=>(s(),t("div",os,[e("div",null,[a[4]||(a[4]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Mapping Name (for saving)",-1)),W(e("input",{type:"text","onUpdate:modelValue":a[0]||(a[0]=r=>_.value.name=r),placeholder:"e.g., Centralizator Template",class:"w-full border border-gray-300 rounded-md px-3 py-2"},null,512),[[ae,_.value.name]])]),e("div",ns,[e("div",null,[a[6]||(a[6]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[Z(" School Name Column "),e("span",{class:"text-red-500"},"*")],-1)),W(e("select",{"onUpdate:modelValue":a[1]||(a[1]=r=>_.value.school_name_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[5]||(a[5]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,as))),128))],544),[[X,_.value.school_name_column]])]),e("div",null,[a[8]||(a[8]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[Z(" Address Column "),e("span",{class:"text-red-500"},"*")],-1)),W(e("select",{"onUpdate:modelValue":a[2]||(a[2]=r=>_.value.address_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[7]||(a[7]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,rs))),128))],544),[[X,_.value.address_column]])]),e("div",null,[a[10]||(a[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Protocol # Column (optional)",-1)),W(e("select",{"onUpdate:modelValue":a[3]||(a[3]=r=>_.value.protocol_number_column=r),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:$},[a[9]||(a[9]=e("option",{value:null},"-- Select Column --",-1)),(s(!0),t(j,null,G(M.headers,r=>(s(),t("option",{key:r,value:r},u(r),9,us))),128))],544),[[X,_.value.protocol_number_column]])])]),e("div",ds,[e("button",{onClick:T,disabled:!E.value,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"}," Save Mapping ",8,is)])]))}}),ps={class:"space-y-4"},ms={class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},vs={class:"grid grid-cols-2 md:grid-cols-5 gap-4 text-sm"},gs={class:"text-2xl font-bold text-blue-900"},fs={class:"text-2xl font-bold text-green-900"},xs={class:"text-2xl font-bold text-yellow-900"},ys={class:"text-2xl font-bold text-orange-900"},bs={class:"text-2xl font-bold text-red-900"},hs={class:"bg-white border rounded-lg overflow-hidden"},ws={class:"p-4 border-b bg-gray-50 flex items-center justify-between"},_s={class:"flex items-center gap-4"},$s={class:"text-sm text-gray-600"},ks={class:"overflow-x-auto",style:{"max-height":"600px","overflow-y":"auto"}},Cs={class:"min-w-full divide-y divide-gray-200 text-sm"},Is={class:"bg-gray-50 sticky top-0 z-10"},Ss={class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-12"},Ms=["checked"],Ps={class:"bg-white divide-y divide-gray-200"},Rs={class:"px-3 py-2"},Fs=["checked","onChange","disabled"],Ns={class:"px-3 py-2"},Ds={class:"px-3 py-2"},Us={class:"px-3 py-2"},Es={class:"px-3 py-2"},Vs={class:"px-3 py-2"},Bs={class:"px-3 py-2"},Ts={key:0,class:"text-xs"},zs={key:1,class:"text-green-600 text-xs"},Ls={class:"flex justify-between items-center flex-wrap gap-4"},As={class:"text-sm text-gray-600 space-y-1 flex-1"},js={key:0,class:"text-red-600 font-medium"},Gs={key:1,class:"text-yellow-600 font-medium"},Hs={key:2,class:"text-green-600"},Ks={key:3,class:"text-blue-600"},Ws={class:"flex gap-2"},Os=["disabled"],qs=ve({__name:"CentralizatorPreview",props:{preview:{},stats:{}},emits:["proceed","cancel"],setup(M,{emit:R}){const B=M,O=R,_=h(""),E=h("all"),$=J(()=>{let p=[...B.preview];if(E.value!=="all"&&(E.value==="with_issues"?p=p.filter(m=>m.issues.length>0):E.value==="cannot_import"?p=p.filter(m=>!m.canImport):p=p.filter(m=>m.status===E.value)),_.value){const m=_.value.toLowerCase();p=p.filter(b=>{var H,F,U,V;return((H=b.schoolName)==null?void 0:H.toLowerCase().includes(m))||((F=b.address)==null?void 0:F.toLowerCase().includes(m))||((U=b.stateRegion)==null?void 0:U.toLowerCase().includes(m))||((V=b.protocolNumber)==null?void 0:V.toLowerCase().includes(m))})}return p}),T=J(()=>$.value.length>0&&$.value.every(p=>p.selected!==!1&&p.canImport)),C=J(()=>B.preview.filter(p=>p.selected!==!1&&p.canImport).length);function a(){const p=!T.value;$.value.forEach(m=>{m.canImport&&(m.selected=p)})}function r(){const p=B.preview.filter(m=>m.selected!==!1&&m.canImport).map(m=>({schoolName:m.schoolName,address:m.address,stateRegion:m.stateRegion,protocolNumber:m.protocolNumber,rawData:m.rawData}));O("proceed",p)}return(p,m)=>(s(),t("div",ps,[e("div",ms,[m[8]||(m[8]=e("h4",{class:"font-semibold text-blue-900 mb-2"},"Import Preview",-1)),e("div",vs,[e("div",null,[m[3]||(m[3]=e("div",{class:"text-blue-700 font-medium"},"Total",-1)),e("div",gs,u(M.stats.total),1)]),e("div",null,[m[4]||(m[4]=e("div",{class:"text-green-700 font-medium"},"New",-1)),e("div",fs,u(M.stats.new),1)]),e("div",null,[m[5]||(m[5]=e("div",{class:"text-yellow-700 font-medium"},"Duplicates",-1)),e("div",xs,u(M.stats.duplicate),1)]),e("div",null,[m[6]||(m[6]=e("div",{class:"text-orange-700 font-medium"},"Issues",-1)),e("div",ys,u(M.stats.with_issues),1)]),e("div",null,[m[7]||(m[7]=e("div",{class:"text-red-700 font-medium"},"Cannot Import",-1)),e("div",bs,u(M.stats.cannot_import),1)])])]),e("div",hs,[e("div",ws,[e("div",_s,[W(e("input",{type:"text","onUpdate:modelValue":m[0]||(m[0]=b=>_.value=b),placeholder:"Search schools...",class:"border rounded px-3 py-1 text-sm"},null,512),[[ae,_.value]]),W(e("select",{"onUpdate:modelValue":m[1]||(m[1]=b=>E.value=b),class:"border rounded px-3 py-1 text-sm"},[...m[9]||(m[9]=[_e('<option value="all">All Status</option><option value="new">New</option><option value="duplicate">Duplicates</option><option value="duplicate_in_file">Duplicates in File</option><option value="with_issues">With Issues</option><option value="cannot_import">Cannot Import</option>',6)])],512),[[X,E.value]])]),e("div",$s," Showing "+u($.value.length)+" of "+u(M.preview.length),1)]),e("div",ks,[e("table",Cs,[e("thead",Is,[e("tr",null,[e("th",Ss,[e("input",{type:"checkbox",checked:T.value,onChange:a,class:"rounded"},null,40,Ms)]),m[10]||(m[10]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Status",-1)),m[11]||(m[11]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"School",-1)),m[12]||(m[12]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Address",-1)),m[13]||(m[13]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"State/Region",-1)),m[14]||(m[14]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Protocol #",-1)),m[15]||(m[15]=e("th",{class:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase"},"Issues",-1))])]),e("tbody",Ps,[(s(!0),t(j,null,G($.value,(b,H)=>(s(),t("tr",{key:H,class:re({"bg-red-50":!b.canImport,"bg-yellow-50":b.status==="duplicate"||b.status==="duplicate_in_file","bg-green-50":b.status==="new"&&b.canImport&&b.issues.length===0})},[e("td",Rs,[e("input",{type:"checkbox",checked:b.selected!==!1,onChange:F=>b.selected=F.target.checked,disabled:!b.canImport,class:"rounded"},null,40,Fs)]),e("td",Ns,[e("span",{class:re(["px-2 py-1 rounded text-xs font-medium",b.status==="new"?"bg-green-100 text-green-800":b.status==="duplicate"?"bg-yellow-100 text-yellow-800":b.status==="duplicate_in_file"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800"])},u(b.status==="new"?"New":b.status==="duplicate"?"Duplicate":b.status==="duplicate_in_file"?"Dup in File":"Issue"),3)]),e("td",Ds,u(b.schoolName||"-"),1),e("td",Us,u(b.address||"-"),1),e("td",Es,u(b.stateRegion||"-"),1),e("td",Vs,u(b.protocolNumber||"-"),1),e("td",Bs,[b.issues.length>0?(s(),t("div",Ts,[(s(!0),t(j,null,G(b.issues,(F,U)=>(s(),t("div",{key:U,class:"text-red-600"}," • "+u(F),1))),128))])):(s(),t("span",zs,"✓ OK"))])],2))),128))])])])]),e("div",Ls,[e("div",As,[M.stats.cannot_import>0?(s(),t("div",js," ⚠ "+u(M.stats.cannot_import)+" record(s) cannot be imported. Please fix them before proceeding. ",1)):S("",!0),C.value===0?(s(),t("div",Gs," ⚠ No records selected. Please select at least one record to import. ")):M.stats.cannot_import===0?(s(),t("div",Hs," ✓ "+u(C.value)+" record(s) ready to import ",1)):S("",!0),M.stats.duplicate>0?(s(),t("div",Ks," ℹ "+u(M.stats.duplicate)+" duplicate(s) will update existing records on import. ",1)):S("",!0)]),e("div",Ws,[e("button",{onClick:m[2]||(m[2]=b=>p.$emit("cancel")),class:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"}," Cancel "),e("button",{onClick:r,disabled:C.value===0||M.stats.cannot_import>0,class:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"}," Proceed with Import ("+u(C.value)+" selected) ",9,Os)])])]))}}),Qs={class:"space-y-6"},Js={class:"bg-white shadow rounded-lg p-6"},Xs={class:"bg-white shadow rounded-lg p-6"},Ys={key:0,class:"mt-3 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded"},Zs={key:1,class:"mt-3 text-sm text-gray-600 flex items-center gap-2"},el={key:2,class:"mt-3 text-sm text-gray-500"},tl={key:3,class:"mt-4 space-y-3"},sl={class:"space-y-1"},ll={class:"text-sm font-medium text-gray-900"},ol={class:"text-xs text-gray-500"},nl={key:0,class:"mx-1"},al={key:1},rl={class:"flex flex-wrap gap-2"},ul=["onClick","disabled"],dl={key:0,class:"flex items-center gap-2"},il={key:1},cl=["onClick","disabled"],pl={key:0,class:"flex items-center gap-2"},ml={key:1},vl={key:4,class:"mt-3"},gl={key:0,class:"bg-white shadow rounded-lg p-6 space-y-6"},fl={key:0,class:"flex flex-wrap gap-2 border-b border-gray-200 pb-3"},xl=["onClick"],yl={key:0,class:"ml-1 text-xs text-yellow-200"},bl={key:1,class:"text-sm text-gray-500"},hl={key:2,class:"space-y-6"},wl={class:"bg-gray-50 border border-gray-200 rounded-lg p-4"},_l={class:"text-sm font-semibold text-gray-800 mb-2"},$l={class:"mb-4"},kl=["value"],Cl={class:"mt-4"},Il={class:"overflow-x-auto border border-gray-200 rounded-md max-h-96 bg-white"},Sl={class:"min-w-full text-xs"},Ml={class:"bg-gray-50 sticky top-0"},Pl={class:"px-2 py-1 border border-gray-200 font-medium"},Rl={key:0,class:"text-green-600 ml-1"},Fl={class:"space-y-4"},Nl={class:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between"},Dl={class:"space-y-1"},Ul={class:"text-sm text-gray-500"},El={class:"flex flex-col sm:flex-row sm:items-center gap-2"},Vl=["disabled"],Bl={value:null},Tl=["value"],zl=["disabled"],Ll={key:0,class:"bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded"},Al={key:1,class:"bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded text-sm"},jl={key:2,class:"bg-gray-50 border border-gray-200 text-gray-600 px-4 py-3 rounded text-sm"},Gl={key:1,class:"bg-white shadow rounded-lg p-6"},Hl={class:"flex items-center justify-between"},Kl=["disabled"],Wl={key:2,class:"bg-white shadow rounded-lg p-6"},Ol={key:3,class:"mt-6"},ql={key:0,class:"bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded"},Ql={class:"text-sm space-y-1"},Jl={key:0},Xl={key:1},Yl={key:2,class:"text-yellow-700"},Zl={key:1,class:"bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded"},eo=ve({__name:"CentralizatorImport",setup(M){const R=h(null),B=h([]),O=h([]),_=h(!1),E=h(null),$=h(null),T=h(!1),C=h(null),a=h([]),r=h(!1),p=h(null),m=h(!1),b=h(!1),H=h(null),F=h(null),U=h(""),V=h({}),K=J(()=>B.value.find(v=>v.name===U.value)||null),n=J(()=>{const v=K.value;if(!v)return[1];const l=Math.min(10,v.totalRows);return Array.from({length:l},(f,g)=>g+1)}),d=J(()=>{const v=K.value;if(!v)return[];const l=V.value[v.name],f=(l==null?void 0:l.headerRow)??1,g=v.preview.find(A=>A.rowNumber===f);return g?g.cells:[]}),x=J(()=>T.value?O.value:O.value.slice(0,3)),z=J(()=>!R.value||B.value.length===0?!1:B.value.every(v=>{const l=V.value[v.name];return l&&l.headerRow>0&&l.mapping.school_name_column&&l.mapping.address_column}));$e(async()=>{await ee(),await se()});function P(v){var f;R.value=v.fileId,B.value=v.sheets,F.value=null,m.value=!1,H.value=null,U.value=((f=v.sheets[0])==null?void 0:f.name)??"";const l={};v.sheets.forEach(g=>{l[g.name]={headerRow:1,mapping:{name:"",school_name_column:null,address_column:null,protocol_number_column:null},selectedMappingId:null,mappingInfo:null}}),V.value=l}async function te(v){P(v),await ee(),await se()}async function ee(){var v,l;_.value=!0,$.value=null;try{const{data:f}=await Q.get("/api/upload/files");f.success?O.value=f.files:$.value="Failed to load stored files."}catch(f){$.value=((l=(v=f.response)==null?void 0:v.data)==null?void 0:l.error)||f.message||"Failed to load stored files."}finally{_.value=!1}}async function Y(v){var l,f;E.value=v,F.value=null;try{const{data:g}=await Q.get(`/api/upload/files/${v}`);P(g)}catch(g){F.value={success:!1,error:((f=(l=g.response)==null?void 0:l.data)==null?void 0:f.error)||g.message||"Failed to load the stored file."},await ee(),await se()}finally{E.value=null}}async function ne(v){var l,f;if(confirm("Delete this uploaded file?")){C.value=v;try{await Q.delete(`/api/upload/files/${v}`),await ee()}catch(g){$.value=((f=(l=g.response)==null?void 0:l.data)==null?void 0:f.error)||g.message||"Failed to delete the stored file."}finally{C.value=null}}}function ue(v){if(!v)return"Unknown date";const l=new Date(v);return Number.isNaN(l.getTime())?v:l.toLocaleString()}function me(v){if(v==null||v<=0)return"Unknown size";const l=["B","KB","MB","GB","TB"],f=Math.min(Math.floor(Math.log(v)/Math.log(1024)),l.length-1),g=v/Math.pow(1024,f);return`${g.toFixed(g>=10||f===0?0:1)} ${l[f]}`}async function se(){var v,l;r.value=!0,p.value=null;try{const{data:f}=await Q.get("/api/centralizator/mappings");a.value=f.mappings||[]}catch(f){p.value=((l=(v=f.response)==null?void 0:v.data)==null?void 0:l.error)||f.message||"Failed to load saved mappings."}finally{r.value=!1}}function xe(v){const l=V.value[v];l&&(l.selectedMappingId=null,l.mappingInfo=null)}function ye(v,l){const f=V.value[v];if(!f)return;const g=new Set(d.value);if(!g.size){f.mappingInfo="Select the header row before applying a saved mapping.";return}const A=D=>D&&g.has(D)?D:null,k=[];l.school_name_column&&!g.has(l.school_name_column)&&k.push(`School "${l.school_name_column}"`),l.address_column&&!g.has(l.address_column)&&k.push(`Address "${l.address_column}"`),l.protocol_number_column&&!g.has(l.protocol_number_column)&&k.push(`Protocol "${l.protocol_number_column}"`),f.mapping={id:l.id,name:l.name,school_name_column:A(l.school_name_column??null),address_column:A(l.address_column??null),protocol_number_column:A(l.protocol_number_column??null)},f.mappingInfo=k.length?`Loaded mapping "${l.name}". Missing columns were skipped: ${k.join(", ")}.`:`Loaded mapping "${l.name}".`}function ge(v){const l=V.value[v];if(!l||l.selectedMappingId===null)return;const f=a.value.find(g=>g.id===l.selectedMappingId);if(!f){l.mappingInfo="Selected mapping was not found. Try refreshing.",l.selectedMappingId=null;return}ye(v,f)}function le(){se()}he(U,v=>{if(!v)return;const l=V.value[v];l&&l.selectedMappingId!==null&&ge(v)});function de(v){const l=B.value.find(D=>D.name===v),f=V.value[v];if(!l||!f)return;const g=l.preview.find(D=>D.rowNumber===f.headerRow);if(!g)return;const A=g.cells,k=A.map(D=>String(D||"").toLowerCase());if(f.mapping.school_name_column&&!A.includes(f.mapping.school_name_column)&&(f.mapping.school_name_column=null),f.mapping.address_column&&!A.includes(f.mapping.address_column)&&(f.mapping.address_column=null),f.mapping.protocol_number_column&&!A.includes(f.mapping.protocol_number_column)&&(f.mapping.protocol_number_column=null),!f.mapping.school_name_column){const D=k.findIndex(oe=>oe.includes("school")||oe.includes("unit")||oe.includes("name")||oe.includes("institut"));D!==-1&&(f.mapping.school_name_column=A[D]||null)}if(!f.mapping.address_column){const D=k.findIndex(oe=>oe.includes("address")||oe.includes("adresa"));D!==-1&&(f.mapping.address_column=A[D]||null)}if(!f.mapping.protocol_number_column){const D=k.findIndex(oe=>oe.includes("protocol")||oe.includes("nr"));D!==-1&&(f.mapping.protocol_number_column=A[D]||null)}f.selectedMappingId!==null&&ge(v)}async function be(){var v,l;if(!(!z.value||!R.value)){b.value=!0,H.value=null;try{const f=await Q.post("/api/centralizator/preview",{fileId:R.value,sheetConfigs:i()});f.data.success&&(f.data.preview.forEach(g=>{g.canImport&&(g.selected=!0)}),H.value=f.data,m.value=!0)}catch(f){F.value={success:!1,error:((l=(v=f.response)==null?void 0:v.data)==null?void 0:l.error)||f.message}}finally{b.value=!1}}}async function w(v){var l,f;if(R.value){F.value=null,m.value=!1;try{const A=(await Q.post("/api/centralizator/import",{fileId:R.value,sheetConfigs:i(),rows:v})).data;F.value={success:!0,imported:A.imported,new:A.new||0,updated:A.updated||0,skipped:A.skipped||0,totalProcessed:A.totalProcessed||A.imported}}catch(g){F.value={success:!1,error:((f=(l=g.response)==null?void 0:l.data)==null?void 0:f.error)||g.message}}}}function i(){return B.value.map(v=>{const l=V.value[v.name];return{sheetName:v.name,headerRow:(l==null?void 0:l.headerRow)??1,columnMapping:(l==null?void 0:l.mapping)??{}}})}function N(v,l){const f=V.value[v];f&&(f.mapping={...l})}function q(v){const l=V.value[v];return l?!!(l.mapping.school_name_column&&l.mapping.address_column):!1}return(v,l)=>{var f;return s(),t("div",Qs,[l[23]||(l[23]=e("div",{class:"mb-2"},[e("h3",{class:"text-xl font-semibold text-gray-900"},"Centralizator"),e("p",{class:"text-sm text-gray-500"}," Upload an Excel file and configure each sheet (State/Region) with its own header row and mapping. ")],-1)),e("section",Js,[l[8]||(l[8]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"1. Upload File",-1)),ce(Ie,{onFileUploaded:te})]),e("section",Xs,[e("div",{class:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between"},[l[9]||(l[9]=e("div",null,[e("h3",{class:"text-lg font-medium text-gray-900"},"Or Select an Existing File"),e("p",{class:"text-sm text-gray-500"}," Choose from recently uploaded Excel files. ")],-1)),e("button",{type:"button",onClick:ee,class:"self-start px-3 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 cursor-pointer"}," Refresh ")]),$.value?(s(),t("div",Ys,u($.value),1)):_.value?(s(),t("div",Zs,[...l[10]||(l[10]=[e("span",{class:"h-4 w-4 border-2 border-gray-300 border-t-green-500 rounded-full animate-spin"},null,-1),Z(" Loading files... ",-1)])])):O.value.length===0?(s(),t("div",el," No stored files yet. Upload a file to populate this list. ")):(s(),t("ul",tl,[(s(!0),t(j,null,G(x.value,g=>(s(),t("li",{key:g.fileId,class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border border-gray-200 rounded-md px-4 py-3"},[e("div",sl,[e("p",ll,u(g.originalName),1),e("p",ol,[Z(" Uploaded "+u(ue(g.uploadedAt))+" ",1),g.sizeBytes?(s(),t("span",nl,"•")):S("",!0),g.sizeBytes?(s(),t("span",al,u(me(g.sizeBytes)),1)):S("",!0)])]),e("div",rl,[e("button",{type:"button",onClick:A=>Y(g.fileId),class:"px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed",disabled:E.value===g.fileId},[E.value===g.fileId?(s(),t("span",dl,[...l[11]||(l[11]=[e("span",{class:"h-3 w-3 border-2 border-white border-t-transparent rounded-full animate-spin"},null,-1),Z(" Loading... ",-1)])])):(s(),t("span",il,"Load File"))],8,ul),e("button",{type:"button",onClick:A=>ne(g.fileId),class:"px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed",disabled:C.value===g.fileId},[C.value===g.fileId?(s(),t("span",pl,[...l[12]||(l[12]=[e("span",{class:"h-3 w-3 border-2 border-white border-t-transparent rounded-full animate-spin"},null,-1),Z(" Deleting... ",-1)])])):(s(),t("span",ml,"Delete"))],8,cl)])]))),128))])),O.value.length>3?(s(),t("div",vl,[e("button",{type:"button",onClick:l[0]||(l[0]=g=>T.value=!T.value),class:"text-sm text-green-700 hover:text-green-800 font-semibold"},u(T.value?"Show less":`Show more (${O.value.length-3} more)`),1)])):S("",!0)]),R.value?(s(),t("section",gl,[l[18]||(l[18]=e("div",{class:"flex flex-col gap-2"},[e("h3",{class:"text-lg font-medium text-gray-900"},"2. Configure Sheets (State/Region)"),e("p",{class:"text-sm text-gray-500"}," Each sheet can have its own header row and mapping. The sheet name will be saved as State/Region. ")],-1)),B.value.length?(s(),t("div",fl,[(s(!0),t(j,null,G(B.value,g=>(s(),t("button",{key:g.name,type:"button",onClick:A=>U.value=g.name,class:re(["px-3 py-2 rounded-md text-sm font-medium border cursor-pointer",U.value===g.name?"bg-green-600 text-white border-green-600":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"])},[Z(u(g.name)+" ",1),q(g.name)?S("",!0):(s(),t("span",yl," • needs mapping "))],10,xl))),128))])):(s(),t("div",bl," No sheets detected yet. ")),K.value?(s(),t("div",hl,[e("div",wl,[e("h4",_l," Header row for "+u(K.value.name),1),e("div",$l,[l[13]||(l[13]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Which row contains the column headers? ",-1)),W(e("select",{"onUpdate:modelValue":l[1]||(l[1]=g=>V.value[K.value.name].headerRow=g),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:l[2]||(l[2]=g=>de(K.value.name))},[(s(!0),t(j,null,G(n.value,g=>(s(),t("option",{key:g,value:g}," Row "+u(g),9,kl))),128))],544),[[X,V.value[K.value.name].headerRow,void 0,{number:!0}]])]),e("div",Cl,[l[15]||(l[15]=e("p",{class:"text-sm font-medium text-gray-700 mb-2"},"Preview (first 10 rows):",-1)),e("div",Il,[e("table",Sl,[e("thead",Ml,[e("tr",null,[l[14]||(l[14]=e("th",{class:"px-2 py-1 text-left border border-gray-200 bg-gray-50"},"Row #",-1)),(s(!0),t(j,null,G(((f=K.value.preview[0])==null?void 0:f.cells)||[],(g,A)=>(s(),t("th",{key:A,class:"px-2 py-1 text-left border border-gray-200 bg-gray-50"}," Col "+u(A+1),1))),128))])]),e("tbody",null,[(s(!0),t(j,null,G(K.value.preview,g=>(s(),t("tr",{key:g.rowNumber,class:re({"bg-green-50 font-semibold":g.rowNumber===V.value[K.value.name].headerRow})},[e("td",Pl,[Z(u(g.rowNumber)+" ",1),g.rowNumber===V.value[K.value.name].headerRow?(s(),t("span",Rl," ✓ Headers ")):S("",!0)]),(s(!0),t(j,null,G(g.cells,(A,k)=>(s(),t("td",{key:k,class:"px-2 py-1 border border-gray-200"},u(A||"-"),1))),128))],2))),128))])])]),l[16]||(l[16]=e("p",{class:"mt-2 text-xs text-gray-500"}," The selected header row is highlighted in green. ",-1))])]),e("div",Fl,[e("div",Nl,[e("div",Dl,[l[17]||(l[17]=e("h3",{class:"text-lg font-medium text-gray-900"},"3. Map Columns",-1)),e("p",Ul," Map the school columns for "+u(K.value.name)+". ",1)]),e("div",El,[W(e("select",{"onUpdate:modelValue":l[3]||(l[3]=g=>V.value[K.value.name].selectedMappingId=g),class:"w-full sm:w-64 border border-gray-300 rounded-md px-3 py-2",disabled:r.value||a.value.length===0,onChange:l[4]||(l[4]=g=>ge(K.value.name))},[e("option",Bl,u(r.value?"Loading saved mappings...":"Select saved mapping"),1),(s(!0),t(j,null,G(a.value,g=>(s(),t("option",{key:g.id,value:g.id},u(g.name),9,Tl))),128))],40,Vl),[[X,V.value[K.value.name].selectedMappingId]]),e("button",{type:"button",onClick:l[5]||(l[5]=g=>xe(K.value.name)),class:"px-3 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 cursor-pointer",disabled:V.value[K.value.name].selectedMappingId===null}," Clear ",8,zl),e("button",{type:"button",onClick:se,class:"px-3 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 cursor-pointer"}," Refresh ")])]),p.value?(s(),t("div",Ll,u(p.value),1)):V.value[K.value.name].mappingInfo?(s(),t("div",Al,u(V.value[K.value.name].mappingInfo),1)):a.value.length===0&&!r.value?(s(),t("div",jl,' No saved mappings yet. Configure the columns and click "Save Mapping" to reuse it later. ')):S("",!0),ce(cs,{headers:d.value,mapping:V.value[K.value.name].mapping,"onUpdate:mapping":l[6]||(l[6]=g=>N(K.value.name,g)),onMappingSaved:le},null,8,["headers","mapping"])])])):S("",!0)])):S("",!0),R.value&&z.value&&!m.value?(s(),t("section",Gl,[l[20]||(l[20]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"5. Preview & Import",-1)),e("div",Hl,[l[19]||(l[19]=e("p",{class:"text-sm text-gray-600"}," Preview the records before importing to check for duplicates and issues. ",-1)),e("button",{onClick:be,disabled:!z.value||b.value,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"},u(b.value?"Loading Preview...":"Preview Import"),9,Kl)])])):S("",!0),m.value&&H.value?(s(),t("section",Wl,[l[21]||(l[21]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"5. Review & Import",-1)),ce(qs,{preview:H.value.preview,stats:H.value.stats,onProceed:w,onCancel:l[7]||(l[7]=g=>m.value=!1)},null,8,["preview","stats"])])):S("",!0),F.value?(s(),t("section",Ol,[F.value.success?(s(),t("div",ql,[l[22]||(l[22]=e("div",{class:"font-semibold mb-2"},"Import completed successfully!",-1)),e("div",Ql,[e("div",null,"✓ Processed: "+u(F.value.totalProcessed||F.value.imported)+" records",1),F.value.new>0?(s(),t("div",Jl,"✓ New records created: "+u(F.value.new),1)):S("",!0),F.value.updated>0?(s(),t("div",Xl,"✓ Existing records updated: "+u(F.value.updated),1)):S("",!0),F.value.skipped>0?(s(),t("div",Yl," ⚠ Skipped: "+u(F.value.skipped)+" records ",1)):S("",!0)])])):(s(),t("div",Zl," Error: "+u(F.value.error),1))])):S("",!0)])}}}),to={class:"space-y-6"},so={class:"bg-white shadow rounded-lg p-6"},lo={class:"flex justify-between items-center mb-4"},oo={class:"text-sm text-gray-500 mt-1"},no={class:"font-mono"},ao={class:"flex gap-2"},ro={key:0},uo={key:1,class:"flex items-center justify-center"},io={class:"flex items-center gap-2 text-sm mb-4"},co={key:0,class:"text-gray-400"},po=["onClick"],mo={key:0,class:"text-gray-400"},vo={class:"bg-white shadow rounded-lg p-6"},go={key:0,class:"text-center py-8 text-gray-500"},fo={key:1,class:"text-center py-8 text-gray-500"},xo={key:2,class:"overflow-x-auto"},yo={class:"min-w-full divide-y divide-gray-200"},bo={class:"bg-white divide-y divide-gray-200"},ho={class:"px-6 py-4 whitespace-nowrap"},wo={class:"flex items-center gap-2"},_o={class:"text-lg"},$o=["onClick"],ko=["onDblclick"],Co={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},Io={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-500"},So={class:"px-6 py-4 whitespace-nowrap text-sm font-medium"},Mo={class:"flex gap-2"},Po=["onClick"],Ro=["onClick"],Fo=["onClick"],No=["onClick"],Do={class:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"},Uo={class:"mt-3"},Eo={class:"mb-4"},Vo={class:"flex justify-end gap-2"},Bo=["disabled"],To={class:"relative top-20 mx-auto p-5 border w-[400px] shadow-lg rounded-md bg-white"},zo={class:"mt-3"},Lo={class:"text-lg font-medium text-gray-900 mb-4"},Ao={class:"mb-4"},jo={class:"block text-sm font-medium text-gray-700 mb-2"},Go={key:0,class:"text-xs text-gray-500 ml-2"},Ho=["placeholder"],Ko={class:"flex justify-end gap-2"},Wo=["disabled"],Oo={class:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"},qo={class:"mt-3"},Qo={class:"text-lg font-medium text-gray-900 mb-4"},Jo={class:"mb-4"},Xo=["value"],Yo={class:"mt-2 text-xs text-gray-500"},Zo={class:"flex justify-end gap-2"},en=["disabled"],tn=ve({__name:"FileStorage",setup(M){const R=h(""),B=h([]),O=h(!1),_=h(!1),E=h(""),$=h(null),T=h(null),C=h(!1),a=h(!1),r=h(!1),p=h(!1),m=h(null),b=h(null),H=h(""),F=h(""),U=h(null),V=h([]),K=J(()=>R.value?R.value.split("/").filter(w=>w):[]);function n(w){return w<0?"":K.value.slice(0,w+1).join("/")}async function d(){var w,i;O.value=!0;try{const N=await Q.get("/api/storage",{params:{folderPath:R.value}});B.value=N.data.items||[]}catch(N){console.error("Error loading files:",N),alert("Error loading files: "+(((i=(w=N.response)==null?void 0:w.data)==null?void 0:i.error)||N.message))}finally{O.value=!1}}function x(w){R.value=w,d()}async function z(){var w,i;if(!E.value.trim()){alert("Please enter a folder name");return}try{await Q.post("/api/storage/folder",{folderName:E.value.trim(),parentPath:R.value}),_.value=!1,E.value="",await d()}catch(N){alert("Error creating folder: "+(((i=(w=N.response)==null?void 0:w.data)==null?void 0:i.error)||N.message))}}async function P(w){const i=w.target;!i.files||i.files.length===0||(await Y(Array.from(i.files),!1),$.value&&($.value.value=""))}async function te(w){const i=w.target;!i.files||i.files.length===0||(await Y(Array.from(i.files),!0),T.value&&(T.value.value=""))}async function ee(w){if(C.value=!1,!!w.dataTransfer){if(w.dataTransfer.items&&w.dataTransfer.items.length>0){const i=Array.from(w.dataTransfer.items),N=[];for(const q of i)if(q.kind==="file"){const v=q.webkitGetAsEntry();if(v)if(v.isDirectory){alert('Please use the "Upload Folder" button to upload folders. Drag and drop folders is not fully supported by browsers.');return}else{const l=q.getAsFile();l&&N.push(l)}}N.length>0&&await Y(N,!1)}else if(w.dataTransfer.files&&w.dataTransfer.files.length>0){const i=Array.from(w.dataTransfer.files),N=i.some(q=>{const v=q;return v.webkitRelativePath&&v.webkitRelativePath.includes("/")});await Y(i,N)}}}async function Y(w,i){var N,q;a.value=!0;try{const v=new FormData,l=[];if(w.forEach(f=>{v.append("files",f);const g=f;i&&g.webkitRelativePath?l.push(g.webkitRelativePath):i&&g.path?l.push(g.path):l.push(f.name)}),v.append("folderPath",R.value),v.append("preserveStructure",i?"true":"false"),i&&(v.append("filePaths",JSON.stringify(l)),l.length>0&&l[0].includes("/"))){const f=l[0].split("/")[0];v.append("folderName",f)}await Q.post("/api/storage/upload",v,{onUploadProgress:f=>{if(f.total){const g=Math.round(f.loaded*100/f.total);console.log(`Upload progress: ${g}%`)}}}),await d()}catch(v){alert("Error uploading files: "+(((q=(N=v.response)==null?void 0:N.data)==null?void 0:q.error)||v.message))}finally{a.value=!1}}function ne(w){window.open(`/api/storage/download?filePath=${encodeURIComponent(w)}`,"_blank")}async function ue(w){var N,q;const i=w.isDirectory?"folder":"file";if(confirm(`Are you sure you want to delete this ${i}? This action cannot be undone.`))try{await Q.delete("/api/storage",{params:{filePath:w.path}}),await d()}catch(v){alert("Error deleting item: "+(((q=(N=v.response)==null?void 0:N.data)==null?void 0:q.error)||v.message))}}function me(w){if(w===0)return"0 Bytes";const i=1024,N=["Bytes","KB","MB","GB"],q=Math.floor(Math.log(w)/Math.log(i));return Math.round(w/Math.pow(i,q)*100)/100+" "+N[q]}function se(w){return w?new Date(w).toLocaleString():"-"}function xe(w){if(m.value=w,!w.isDirectory&&w.name.includes(".")){const i=w.name.split(".");i.pop(),H.value=i.join(".")}else H.value=w.name;r.value=!0,setTimeout(()=>{var i,N;(i=U.value)==null||i.focus(),(N=U.value)==null||N.select()},100)}async function ye(){var N,q;if(!m.value||!H.value.trim()){alert("Please enter a name");return}let w=H.value.trim();if(!m.value.isDirectory){const v=m.value.name.includes(".")?"."+m.value.name.split(".").pop():"";w.endsWith(v)&&(w=w.slice(0,-v.length)),w=w+v}const i=w.replace(/[<>:"/\\|?*]/g,"");if(i!==w){alert('Invalid name. Cannot contain: < > : " / \\ | ? *');return}try{await Q.post("/api/storage/rename",{filePath:m.value.path,newName:i}),r.value=!1,m.value=null,H.value="",await d()}catch(v){alert("Error renaming: "+(((q=(N=v.response)==null?void 0:N.data)==null?void 0:q.error)||v.message))}}async function ge(w){b.value=w,F.value=de(w.path),await le(),p.value=!0}async function le(){try{const w=await Q.get("/api/storage/folders");V.value=w.data.folders||[]}catch(w){console.error("Error loading folders:",w),V.value=[]}}function de(w){if(!w)return"";const i=w.split("/").filter(N=>N);return i.pop(),i.join("/")}async function be(){var i,N;if(!b.value)return;const w=de(b.value.path);if(F.value===w){alert("Item is already in this location");return}try{await Q.post("/api/storage/move",{filePath:b.value.path,destinationPath:F.value||""}),p.value=!1,b.value=null,F.value="",await d()}catch(q){alert("Error moving item: "+(((N=(i=q.response)==null?void 0:i.data)==null?void 0:N.error)||q.message))}}return $e(()=>{d()}),(w,i)=>{var N,q,v,l,f,g,A;return s(),t("div",to,[e("div",so,[e("div",lo,[e("div",null,[i[18]||(i[18]=e("h3",{class:"text-lg font-medium text-gray-900"},"File Storage",-1)),e("p",oo,[i[17]||(i[17]=Z(" Current folder: ",-1)),e("span",no,u(R.value||"/"),1)])]),e("div",ao,[e("button",{onClick:i[0]||(i[0]=k=>_.value=!0),class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 cursor-pointer"}," + New Folder "),e("button",{onClick:i[1]||(i[1]=k=>{var D;return(D=$.value)==null?void 0:D.click()}),class:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer"}," + Upload Files "),e("button",{onClick:i[2]||(i[2]=k=>{var D;return(D=T.value)==null?void 0:D.click()}),class:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 cursor-pointer"}," 📁 Upload Folder ")])]),e("div",{onDrop:fe(ee,["prevent"]),onDragover:i[3]||(i[3]=fe(k=>C.value=!0,["prevent"])),onDragleave:i[4]||(i[4]=fe(k=>C.value=!1,["prevent"])),onDragenter:i[5]||(i[5]=fe(()=>{},["prevent"])),onClick:i[6]||(i[6]=k=>{var D;return!a.value&&((D=$.value)==null?void 0:D.click())}),class:re(["border-2 border-dashed rounded-lg p-8 text-center transition-colors mb-4",C.value?"border-purple-500 bg-purple-50":"border-gray-300 bg-gray-50",a.value?"opacity-50 cursor-not-allowed":"cursor-pointer"])},[a.value?(s(),t("div",uo,[...i[20]||(i[20]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"},null,-1),e("span",{class:"ml-3 text-gray-600"},"Uploading...",-1)])])):(s(),t("div",ro,[...i[19]||(i[19]=[_e('<svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><p class="mt-2 text-sm text-gray-600"><span class="font-medium text-purple-600">Drag and drop</span> files or folders here </p><p class="text-xs text-gray-500 mt-1"> Or click the buttons above to upload files or folders </p>',3)])]))],34),e("div",io,[e("button",{onClick:i[7]||(i[7]=k=>x("")),class:"text-blue-600 hover:text-blue-800 cursor-pointer"}," Home "),R.value?(s(),t("span",co,"/")):S("",!0),(s(!0),t(j,null,G(K.value,(k,D)=>(s(),t(j,{key:D},[e("button",{onClick:oe=>x(n(D)),class:"text-blue-600 hover:text-blue-800 cursor-pointer"},u(k),9,po),D<K.value.length-1?(s(),t("span",mo,"/")):S("",!0)],64))),128))]),e("input",{ref_key:"fileInputRef",ref:$,type:"file",multiple:"",onChange:P,class:"hidden"},null,544),e("input",{ref_key:"folderInputRef",ref:T,type:"file",webkitdirectory:"",directory:"",multiple:"",onChange:te,class:"hidden"},null,544)]),e("div",vo,[O.value?(s(),t("div",go," Loading... ")):B.value.length===0?(s(),t("div",fo," This folder is empty ")):(s(),t("div",xo,[e("table",yo,[i[21]||(i[21]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Name "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Size "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Modified "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Actions ")])],-1)),e("tbody",bo,[(s(!0),t(j,null,G(B.value,k=>(s(),t("tr",{key:k.path,class:"hover:bg-gray-50"},[e("td",ho,[e("div",wo,[e("span",_o,u(k.isDirectory?"📁":"📄"),1),k.isDirectory?(s(),t("button",{key:0,onClick:D=>x(k.path),class:"text-blue-600 hover:text-blue-800 cursor-pointer font-medium"},u(k.name),9,$o)):(s(),t("span",{key:1,class:"font-medium text-gray-900 cursor-pointer hover:text-blue-600",onDblclick:D=>xe(k),title:"Double-click to rename"},u(k.name),41,ko))])]),e("td",Co,u(k.isDirectory?"-":me(k.size)),1),e("td",Io,u(se(k.modified)),1),e("td",So,[e("div",Mo,[k.isDirectory?S("",!0):(s(),t("button",{key:0,onClick:D=>ne(k.path),class:"text-blue-600 hover:text-blue-900 cursor-pointer",title:"Download"}," Download ",8,Po)),e("button",{onClick:D=>xe(k),class:"text-purple-600 hover:text-purple-900 cursor-pointer",title:"Rename"}," Rename ",8,Ro),e("button",{onClick:D=>ge(k),class:"text-green-600 hover:text-green-900 cursor-pointer",title:"Move"}," Move ",8,Fo),e("button",{onClick:D=>ue(k),class:"text-red-600 hover:text-red-900 cursor-pointer",title:"Delete"}," Delete ",8,No)])])]))),128))])])]))]),_.value?(s(),t("div",{key:0,class:"fixed inset-0 bg-gray-600/75 overflow-y-auto h-full w-full z-50",onClick:i[10]||(i[10]=fe(k=>_.value=!1,["self"]))},[e("div",Do,[e("div",Uo,[i[23]||(i[23]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Create New Folder",-1)),e("div",Eo,[i[22]||(i[22]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Folder Name",-1)),W(e("input",{"onUpdate:modelValue":i[8]||(i[8]=k=>E.value=k),type:"text",class:"w-full border border-gray-300 rounded-md px-3 py-2",placeholder:"Enter folder name",onKeyup:ie(z,["enter"])},null,544),[[ae,E.value]])]),e("div",Vo,[e("button",{type:"button",onClick:i[9]||(i[9]=k=>_.value=!1),class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 cursor-pointer"}," Cancel "),e("button",{onClick:z,disabled:!E.value.trim(),class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"}," Create ",8,Bo)])])])])):S("",!0),r.value?(s(),t("div",{key:1,class:"fixed inset-0 bg-gray-600/75 overflow-y-auto h-full w-full z-50",onClick:i[13]||(i[13]=fe(k=>r.value=!1,["self"]))},[e("div",To,[e("div",zo,[e("h3",Lo,"Rename "+u((N=m.value)!=null&&N.isDirectory?"Folder":"File"),1),e("div",Ao,[e("label",jo,[i[24]||(i[24]=Z(" New Name ",-1)),(q=m.value)!=null&&q.isDirectory?S("",!0):(s(),t("span",Go," (Extension will be preserved: "+u((v=m.value)!=null&&v.name.includes(".")?"."+m.value.name.split(".").pop():"none")+") ",1))]),W(e("input",{"onUpdate:modelValue":i[11]||(i[11]=k=>H.value=k),type:"text",class:"w-full border border-gray-300 rounded-md px-3 py-2",placeholder:`Enter new ${(l=m.value)!=null&&l.isDirectory?"folder":"file"} name`,onKeyup:ie(ye,["enter"]),ref_key:"renameInputRef",ref:U},null,40,Ho),[[ae,H.value]])]),e("div",Ko,[e("button",{type:"button",onClick:i[12]||(i[12]=k=>r.value=!1),class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 cursor-pointer"}," Cancel "),e("button",{onClick:ye,disabled:!H.value.trim(),class:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"}," Rename ",8,Wo)])])])])):S("",!0),p.value?(s(),t("div",{key:2,class:"fixed inset-0 bg-gray-600/75 overflow-y-auto h-full w-full z-50",onClick:i[16]||(i[16]=fe(k=>p.value=!1,["self"]))},[e("div",Oo,[e("div",qo,[e("h3",Qo,"Move "+u((f=b.value)!=null&&f.isDirectory?"Folder":"File"),1),e("div",Jo,[i[26]||(i[26]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Destination Folder",-1)),W(e("select",{"onUpdate:modelValue":i[14]||(i[14]=k=>F.value=k),class:"w-full border border-gray-300 rounded-md px-3 py-2"},[i[25]||(i[25]=e("option",{value:""},"Root (/)",-1)),(s(!0),t(j,null,G(V.value,k=>(s(),t("option",{key:k.path,value:k.path},u(k.name),9,Xo))),128))],512),[[X,F.value]]),e("p",Yo," Current: "+u(((g=b.value)==null?void 0:g.path)||""),1)]),e("div",Zo,[e("button",{type:"button",onClick:i[15]||(i[15]=k=>p.value=!1),class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 cursor-pointer"}," Cancel "),e("button",{onClick:be,disabled:F.value===de(((A=b.value)==null?void 0:A.path)||""),class:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"}," Move ",8,en)])])])])):S("",!0)])}}}),we="/api",sn=Re("rules",()=>{const M=h([]),R=h(!1),B=h(null);async function O(){var a,r;R.value=!0,B.value=null;try{const p=await Q.get(`${we}/rules`);M.value=p.data.rules}catch(p){B.value=((r=(a=p.response)==null?void 0:a.data)==null?void 0:r.error)||p.message,console.error("Error fetching rules:",p)}finally{R.value=!1}}async function _(a){var r,p;try{const m=await Q.post(`${we}/rules`,a);return await O(),m.data.rule}catch(m){throw new Error(((p=(r=m.response)==null?void 0:r.data)==null?void 0:p.error)||m.message)}}async function E(a,r){var p,m;try{const b=await Q.put(`${we}/rules/${a}`,r);return await O(),b.data.rule}catch(b){throw new Error(((m=(p=b.response)==null?void 0:p.data)==null?void 0:m.error)||b.message)}}async function $(a){var r,p;try{await Q.delete(`${we}/rules/${a}`),await O()}catch(m){throw new Error(((p=(r=m.response)==null?void 0:r.data)==null?void 0:p.error)||m.message)}}const T=h([]);function C(){return T.value=M.value.filter(a=>a.is_active),T.value}return{rules:M,activeRules:T,loading:R,error:B,fetchRules:O,createRule:_,updateRule:E,deleteRule:$,getActiveRules:C}}),ln={class:"px-4 py-6 sm:px-0"},on={class:"mb-6 border-b border-gray-200"},nn={class:"-mb-px flex space-x-8"},an={key:0},rn={key:1},un={key:2},dn={key:3},cn={class:"bg-white shadow rounded-lg p-6 mb-6"},pn={class:"bg-white shadow rounded-lg p-6 mb-6"},mn={key:0,class:"mt-3 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded"},vn={key:1,class:"mt-3 text-sm text-gray-600 flex items-center gap-2"},gn={key:2,class:"mt-3 text-sm text-gray-500"},fn={key:3,class:"mt-4 space-y-3"},xn={class:"space-y-1"},yn={class:"text-sm font-medium text-gray-900"},bn={class:"text-xs text-gray-500"},hn={key:0,class:"mx-1"},wn={key:1},_n={class:"flex flex-wrap gap-2"},$n=["onClick","disabled"],kn={key:0,class:"flex items-center gap-2"},Cn={key:1},In=["onClick","disabled"],Sn={key:0,class:"flex items-center gap-2"},Mn={key:1},Pn={key:4,class:"mt-3"},Rn={key:0,class:"bg-white shadow rounded-lg p-6 mb-6"},Fn={class:"space-y-2"},Nn=["value"],Dn={key:1,class:"bg-white shadow rounded-lg p-6 mb-6"},Un={class:"mb-4"},En=["value"],Vn={class:"mt-4"},Bn={class:"overflow-x-auto border border-gray-200 rounded-md max-h-96"},Tn={class:"min-w-full text-xs"},zn={class:"bg-gray-50 sticky top-0"},Ln={class:"px-2 py-1 border border-gray-200 font-medium"},An={key:0,class:"text-green-600 ml-1"},jn={key:2,class:"bg-white shadow rounded-lg p-6 mb-6 space-y-4"},Gn={class:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between"},Hn={class:"flex flex-col sm:flex-row sm:items-center gap-2"},Kn=["disabled"],Wn={value:null},On=["value"],qn=["disabled"],Qn={key:0,class:"bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded"},Jn={key:1,class:"bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded text-sm"},Xn={key:2,class:"bg-gray-50 border border-gray-200 text-gray-600 px-4 py-3 rounded text-sm"},Yn={key:3,class:"bg-white shadow rounded-lg p-6 mb-6"},Zn={key:4,class:"bg-white shadow rounded-lg p-6 mb-6"},ea={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ta=["value"],sa={key:5,class:"bg-white shadow rounded-lg p-6"},la={class:"flex items-center justify-between"},oa=["disabled"],na={key:6,class:"bg-white shadow rounded-lg p-6"},aa={key:7,class:"bg-white shadow rounded-lg p-6 mt-4"},ra={class:"flex items-center justify-between"},ua=["disabled"],da={key:8,class:"mt-6"},ia={key:0,class:"bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded"},ca={class:"text-sm space-y-1"},pa={key:0},ma={key:1},va={key:2,class:"text-yellow-700"},ga={key:1,class:"bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded"},ka=ve({__name:"Upload",setup(M){const R=h("import"),B=Fe(),O=Ue(),_=Ee(),E=sn(),$=h(null),T=h([]),C=h(null),a=h(null),r=h(1),p=h({name:"",name_column:null,phone_column:null,email_column:null,group_column:null,business_column:null}),m=h([]),b=h(null),H=h(""),F=h(!1),U=h(null),V=h([]),K=h(!1),n=h(null),d=h(null),x=h(!1),z=h(null),P=h([]),te=h(!1),ee=h(null),Y=h(null),ne=h(null),ue=h(!1),me=h(!1),se=h(null),xe=J(()=>_.groups),ye=J(()=>{if(!a.value)return[1];const y=Math.min(10,a.value.totalRows);return Array.from({length:y},(o,I)=>I+1)}),ge=J(()=>x.value?V.value:V.value.slice(0,3)),le=J(()=>{if(!a.value||!a.value.preview)return[];const y=a.value.preview.find(o=>o.rowNumber===r.value);return y?y.cells:[]}),de=J(()=>C.value&&r.value>0&&le.value.length>0&&p.value.name_column&&p.value.phone_column&&(b.value||H.value));$e(async()=>{await _.fetchGroups(),await E.fetchRules(),await i(),await f()});function be(y){$.value=y.fileId,T.value=y.sheets,C.value=null,a.value=null,U.value=null,Y.value=null,ne.value=null}async function w(y){be(y),await i(),await f()}async function i(){var y,o;K.value=!0,d.value=null;try{const{data:I}=await Q.get("/api/upload/files");I.success?V.value=I.files:d.value="Failed to load stored files."}catch(I){d.value=((o=(y=I.response)==null?void 0:y.data)==null?void 0:o.error)||I.message||"Failed to load stored files."}finally{K.value=!1}}async function N(y){var o,I;n.value=y,U.value=null;try{const{data:c}=await Q.get(`/api/upload/files/${y}`);be(c)}catch(c){U.value={success:!1,error:((I=(o=c.response)==null?void 0:o.data)==null?void 0:I.error)||c.message||"Failed to load the stored file."},await i(),await f()}finally{n.value=null}}async function q(y){var o,I;if(confirm("Delete this uploaded file?")){z.value=y;try{await Q.delete(`/api/upload/files/${y}`),await i()}catch(c){alert("Error deleting file: "+(((I=(o=c.response)==null?void 0:o.data)==null?void 0:I.error)||c.message))}finally{z.value=null}}}function v(y){if(!y)return"Unknown date";const o=new Date(y);return Number.isNaN(o.getTime())?y:o.toLocaleString()}function l(y){if(y==null||y<=0)return"Unknown size";const o=["B","KB","MB","GB","TB"],I=Math.min(Math.floor(Math.log(y)/Math.log(1024)),o.length-1),c=y/Math.pow(1024,I);return`${c.toFixed(c>=10||I===0?0:1)} ${o[I]}`}async function f(){var y,o;te.value=!0,ee.value=null;try{const{data:I}=await Q.get("/api/upload/mappings");P.value=I.mappings||[]}catch(I){ee.value=((o=(y=I.response)==null?void 0:y.data)==null?void 0:o.error)||I.message||"Failed to load saved mappings."}finally{te.value=!1}}function g(){Y.value=null,ne.value=null}function A(y){if(!le.value.length){ne.value="Select the header row before applying a saved mapping.";return}const o=new Set(le.value),I=L=>L&&o.has(L)?L:null,c=[];y.name_column&&!o.has(y.name_column)&&c.push(`Name "${y.name_column}"`),y.phone_column&&!o.has(y.phone_column)&&c.push(`Phone "${y.phone_column}"`),y.email_column&&!o.has(y.email_column)&&c.push(`Email "${y.email_column}"`),y.group_column&&!o.has(y.group_column)&&c.push(`Group "${y.group_column}"`),y.business_column&&!o.has(y.business_column)&&c.push(`Business "${y.business_column}"`),p.value={id:y.id,name:y.name,name_column:I(y.name_column??null),phone_column:I(y.phone_column??null),email_column:I(y.email_column??null),group_column:I(y.group_column??null),business_column:I(y.business_column??null)},ne.value=c.length?`Loaded mapping "${y.name}". Missing columns were skipped: ${c.join(", ")}.`:`Loaded mapping "${y.name}".`}function k(){if(Y.value===null)return;const y=P.value.find(o=>o.id===Y.value);if(!y){ne.value="Selected mapping was not found. Try refreshing.",Y.value=null;return}A(y)}function D(){f()}he(Y,y=>{if(y===null){ne.value=null;return}k()});function oe(){C.value&&(a.value=T.value.find(y=>y.name===C.value)||null,r.value=1,p.value={name:"",name_column:null,phone_column:null,email_column:null,group_column:null,business_column:null},ke())}function ke(){if(!a.value)return;const y=a.value.preview.find(c=>c.rowNumber===r.value);if(!y)return;const o=y.cells,I=o.map(c=>String(c||"").toLowerCase());if(p.value.name_column&&!o.includes(p.value.name_column)&&(p.value.name_column=null),p.value.phone_column&&!o.includes(p.value.phone_column)&&(p.value.phone_column=null),p.value.email_column&&!o.includes(p.value.email_column)&&(p.value.email_column=null),p.value.business_column&&!o.includes(p.value.business_column)&&(p.value.business_column=null),p.value.group_column&&!o.includes(p.value.group_column)&&(p.value.group_column=null),!p.value.name_column){const c=I.findIndex(L=>L.includes("name")||L.includes("nume"));c!==-1&&(p.value.name_column=o[c]||null)}if(!p.value.phone_column){const c=I.findIndex(L=>L.includes("phone")||L.includes("telefon")||L.includes("tel"));c!==-1&&(p.value.phone_column=o[c]||null)}if(!p.value.email_column){const c=I.findIndex(L=>L.includes("email")||L.includes("e-mail")||L.includes("mail"));c!==-1&&(p.value.email_column=o[c]||null)}if(!p.value.business_column){const c=I.findIndex(L=>L.includes("business")||L.includes("institution")||L.includes("instituție"));c!==-1&&(p.value.business_column=o[c]||null)}Y.value!==null&&k()}async function Se(){var y,o;if(!(!de.value||!$.value||!C.value)){me.value=!0,se.value=null;try{const I=await Q.post("/api/contacts/preview",{fileId:$.value,sheetName:C.value,columnMapping:p.value,rules:m.value,headerRow:r.value});I.data.success&&(I.data.preview.forEach(c=>{c.canImport&&(c.selected=!0)}),se.value=I.data,ue.value=!0)}catch(I){U.value={success:!1,error:((o=(y=I.response)==null?void 0:y.data)==null?void 0:o.error)||I.message}}finally{me.value=!1}}}async function Me(y){var o,I;if(!(!$.value||!C.value)){F.value=!0,U.value=null,ue.value=!1;try{let c=b.value;H.value&&!c&&(c=(await _.createGroup(H.value)).id);const pe=(await Q.post("/api/contacts/import",{fileId:$.value,sheetName:C.value,columnMapping:p.value,groupId:c,rules:m.value,headerRow:r.value,correctedContacts:y})).data;U.value={success:!0,imported:pe.imported,new:pe.new||0,updated:pe.updated||0,skipped:pe.skipped||0,totalProcessed:pe.totalProcessed||pe.imported},await O.fetchContacts(),setTimeout(()=>{B.push("/contacts")},2e3)}catch(c){U.value={success:!1,error:((I=(o=c.response)==null?void 0:o.data)==null?void 0:I.error)||c.message}}finally{F.value=!1}}}async function Pe(){var y,o;if(!(!de.value||!$.value||!C.value)){F.value=!0,U.value=null;try{let I=b.value;H.value&&!I&&(I=(await _.createGroup(H.value)).id);const L=(await Q.post("/api/contacts/import",{fileId:$.value,sheetName:C.value,columnMapping:p.value,groupId:I,rules:m.value,headerRow:r.value})).data;U.value={success:!0,imported:L.imported,new:L.new||0,updated:L.updated||0,skipped:L.skipped||0,totalProcessed:L.totalProcessed||L.imported},await O.fetchContacts(),setTimeout(()=>{B.push("/contacts")},2e3)}catch(I){U.value={success:!1,error:((o=(y=I.response)==null?void 0:y.data)==null?void 0:o.error)||I.message}}finally{F.value=!1}}}return(y,o)=>{var I;return s(),t("div",ln,[o[38]||(o[38]=e("div",{class:"mb-6"},[e("h2",{class:"text-3xl font-bold text-gray-900"},"Upload Excel File"),e("p",{class:"mt-1 text-sm text-gray-500"},"Upload an Excel file and map columns to import contacts or check protocols")],-1)),e("div",on,[e("nav",nn,[e("button",{onClick:o[0]||(o[0]=c=>R.value="import"),class:re(["py-4 px-1 border-b-2 font-medium text-sm cursor-pointer",R.value==="import"?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Import Contacts ",2),e("button",{onClick:o[1]||(o[1]=c=>R.value="protocol"),class:re(["py-4 px-1 border-b-2 font-medium text-sm cursor-pointer",R.value==="protocol"?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Protocol Check ",2),e("button",{onClick:o[2]||(o[2]=c=>R.value="centralizator"),class:re(["py-4 px-1 border-b-2 font-medium text-sm cursor-pointer",R.value==="centralizator"?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Centralizator ",2),e("button",{onClick:o[3]||(o[3]=c=>R.value="storage"),class:re(["py-4 px-1 border-b-2 font-medium text-sm cursor-pointer",R.value==="storage"?"border-green-500 text-green-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," File Storage ",2)])]),R.value==="protocol"?(s(),t("div",an,[ce(De,{"hide-header":!0})])):R.value==="storage"?(s(),t("div",rn,[ce(tn)])):R.value==="centralizator"?(s(),t("div",un,[ce(eo)])):(s(),t("div",dn,[e("div",cn,[o[15]||(o[15]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"1. Upload File",-1)),ce(Ie,{onFileUploaded:w})]),e("div",pn,[e("div",{class:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between"},[o[16]||(o[16]=e("div",null,[e("h3",{class:"text-lg font-medium text-gray-900"},"Or Select an Existing File"),e("p",{class:"text-sm text-gray-500"}," Choose from recently uploaded Excel files. Hidden columns and protocol decisions remain in the file. ")],-1)),e("button",{type:"button",onClick:i,class:"self-start px-3 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 cursor-pointer"}," Refresh ")]),d.value?(s(),t("div",mn,u(d.value),1)):K.value?(s(),t("div",vn,[...o[17]||(o[17]=[e("span",{class:"h-4 w-4 border-2 border-gray-300 border-t-green-500 rounded-full animate-spin"},null,-1),Z(" Loading files... ",-1)])])):V.value.length===0?(s(),t("div",gn," No stored files yet. Upload a file to populate this list. ")):(s(),t("ul",fn,[(s(!0),t(j,null,G(ge.value,c=>(s(),t("li",{key:c.fileId,class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border border-gray-200 rounded-md px-4 py-3"},[e("div",xn,[e("p",yn,u(c.originalName),1),e("p",bn,[Z(" Uploaded "+u(v(c.uploadedAt))+" ",1),c.sizeBytes?(s(),t("span",hn,"•")):S("",!0),c.sizeBytes?(s(),t("span",wn,u(l(c.sizeBytes)),1)):S("",!0)])]),e("div",_n,[e("button",{type:"button",onClick:L=>N(c.fileId),class:"px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed",disabled:n.value===c.fileId},[n.value===c.fileId?(s(),t("span",kn,[...o[18]||(o[18]=[e("span",{class:"h-3 w-3 border-2 border-white border-t-transparent rounded-full animate-spin"},null,-1),Z(" Loading... ",-1)])])):(s(),t("span",Cn,"Load File"))],8,$n),e("button",{type:"button",onClick:L=>q(c.fileId),class:"px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed",disabled:z.value===c.fileId},[z.value===c.fileId?(s(),t("span",Sn,[...o[19]||(o[19]=[e("span",{class:"h-3 w-3 border-2 border-white border-t-transparent rounded-full animate-spin"},null,-1),Z(" Deleting... ",-1)])])):(s(),t("span",Mn,"Delete"))],8,In)])]))),128))])),V.value.length>3?(s(),t("div",Pn,[e("button",{type:"button",onClick:o[4]||(o[4]=c=>x.value=!x.value),class:"text-sm text-green-700 hover:text-green-800 font-semibold"},u(x.value?"Show less":`Show more (${V.value.length-3} more)`),1)])):S("",!0)]),$.value?(s(),t("div",Rn,[o[20]||(o[20]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"2. Select Sheet",-1)),e("div",Fn,[(s(!0),t(j,null,G(T.value,c=>(s(),t("label",{key:c.name,class:"flex items-center"},[W(e("input",{type:"radio",value:c.name,"onUpdate:modelValue":o[5]||(o[5]=L=>C.value=L),class:"mr-2",onChange:oe},null,40,Nn),[[Ne,C.value]]),e("span",null,u(c.name)+" ("+u(c.rowCount)+" rows, "+u(c.headers.length)+" columns)",1)]))),128))])])):S("",!0),C.value&&a.value?(s(),t("div",Dn,[o[25]||(o[25]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"3. Select Header Row",-1)),e("div",Un,[o[21]||(o[21]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Which row contains the column headers? ",-1)),W(e("select",{"onUpdate:modelValue":o[6]||(o[6]=c=>r.value=c),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:ke},[(s(!0),t(j,null,G(ye.value,c=>(s(),t("option",{key:c,value:c}," Row "+u(c),9,En))),128))],544),[[X,r.value]])]),e("div",Vn,[o[23]||(o[23]=e("p",{class:"text-sm font-medium text-gray-700 mb-2"},"Preview (first 10 rows):",-1)),e("div",Bn,[e("table",Tn,[e("thead",zn,[e("tr",null,[o[22]||(o[22]=e("th",{class:"px-2 py-1 text-left border border-gray-200 bg-gray-50"},"Row #",-1)),(s(!0),t(j,null,G(((I=a.value.preview[0])==null?void 0:I.cells)||[],(c,L)=>(s(),t("th",{key:L,class:"px-2 py-1 text-left border border-gray-200 bg-gray-50"}," Col "+u(L+1),1))),128))])]),e("tbody",null,[(s(!0),t(j,null,G(a.value.preview,c=>(s(),t("tr",{key:c.rowNumber,class:re({"bg-green-50 font-semibold":c.rowNumber===r.value})},[e("td",Ln,[Z(u(c.rowNumber)+" ",1),c.rowNumber===r.value?(s(),t("span",An,"✓ Headers")):S("",!0)]),(s(!0),t(j,null,G(c.cells,(L,pe)=>(s(),t("td",{key:pe,class:"px-2 py-1 border border-gray-200"},u(L||"-"),1))),128))],2))),128))])])]),o[24]||(o[24]=e("p",{class:"mt-2 text-xs text-gray-500"}," The selected header row is highlighted in green. Make sure this row contains your column names. ",-1))])])):S("",!0),C.value&&a.value&&le.value.length>0?(s(),t("div",jn,[e("div",Gn,[o[26]||(o[26]=e("div",{class:"space-y-1"},[e("h3",{class:"text-lg font-medium text-gray-900"},"4. Map Columns"),e("p",{class:"text-sm text-gray-500"}," Load a saved mapping to auto-fill the column selections, or adjust manually below. ")],-1)),e("div",Hn,[W(e("select",{"onUpdate:modelValue":o[7]||(o[7]=c=>Y.value=c),class:"w-full sm:w-64 border border-gray-300 rounded-md px-3 py-2",disabled:te.value||P.value.length===0},[e("option",Wn,u(te.value?"Loading saved mappings...":"Select saved mapping"),1),(s(!0),t(j,null,G(P.value,c=>(s(),t("option",{key:c.id,value:c.id},u(c.name),9,On))),128))],8,Kn),[[X,Y.value]]),e("button",{type:"button",onClick:g,class:"px-3 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 cursor-pointer",disabled:Y.value===null}," Clear ",8,qn),e("button",{type:"button",onClick:f,class:"px-3 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 cursor-pointer"}," Refresh ")])]),ee.value?(s(),t("div",Qn,u(ee.value),1)):ne.value?(s(),t("div",Jn,u(ne.value),1)):P.value.length===0&&!te.value?(s(),t("div",Xn,' No saved mappings yet. Configure the columns and click "Save Mapping" to reuse it later. ')):S("",!0),ce(Ke,{headers:le.value,mapping:p.value,"onUpdate:mapping":o[8]||(o[8]=c=>p.value=c),onMappingSaved:D},null,8,["headers","mapping"])])):S("",!0),C.value&&a.value&&le.value.length>0?(s(),t("div",Yn,[o[27]||(o[27]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"5. Add Rules (Optional)",-1)),ce(lt,{headers:le.value,rules:m.value,"onUpdate:rules":o[9]||(o[9]=c=>m.value=c)},null,8,["headers","rules"])])):S("",!0),C.value&&a.value?(s(),t("div",Zn,[o[31]||(o[31]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"6. Select or Create Group",-1)),e("div",ea,[e("div",null,[o[29]||(o[29]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Existing Group",-1)),W(e("select",{"onUpdate:modelValue":o[10]||(o[10]=c=>b.value=c),class:"w-full border border-gray-300 rounded-md px-3 py-2",onChange:o[11]||(o[11]=c=>H.value="")},[o[28]||(o[28]=e("option",{value:null},"-- Select Group --",-1)),(s(!0),t(j,null,G(xe.value,c=>(s(),t("option",{key:c.id,value:c.id},u(c.name),9,ta))),128))],544),[[X,b.value]])]),e("div",null,[o[30]||(o[30]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Or Create New Group",-1)),W(e("input",{type:"text","onUpdate:modelValue":o[12]||(o[12]=c=>H.value=c),placeholder:"Enter group name",class:"w-full border border-gray-300 rounded-md px-3 py-2",onInput:o[13]||(o[13]=c=>b.value=null)},null,544),[[ae,H.value]])])])])):S("",!0),C.value&&a.value&&le.value.length>0&&!ue.value?(s(),t("div",sa,[o[33]||(o[33]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"7. Preview & Validate",-1)),e("div",la,[o[32]||(o[32]=e("p",{class:"text-sm text-gray-600"}," Preview all contacts before importing to check for duplicates and issues ",-1)),e("button",{onClick:Se,disabled:!de.value||me.value,class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"},u(me.value?"Loading Preview...":"Preview Import"),9,oa)])])):S("",!0),ue.value&&se.value?(s(),t("div",na,[o[34]||(o[34]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"7. Review & Import",-1)),ce(ls,{preview:se.value.preview,stats:se.value.stats,onProceed:Me,onCancel:o[14]||(o[14]=c=>ue.value=!1)},null,8,["preview","stats"])])):S("",!0),C.value&&a.value&&le.value.length>0&&!ue.value?(s(),t("div",aa,[o[36]||(o[36]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"8. Import Contacts (Skip Preview)",-1)),e("div",ra,[o[35]||(o[35]=e("p",{class:"text-sm text-gray-500"}," Import without preview (not recommended) ",-1)),e("button",{onClick:Pe,disabled:!de.value||F.value,class:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"},u(F.value?"Importing...":"Import Without Preview"),9,ua)])])):S("",!0),U.value?(s(),t("div",da,[U.value.success?(s(),t("div",ia,[o[37]||(o[37]=e("div",{class:"font-semibold mb-2"},"Import completed successfully!",-1)),e("div",ca,[e("div",null,"✓ Processed: "+u(U.value.totalProcessed||U.value.imported)+" contacts",1),U.value.new>0?(s(),t("div",pa,"✓ New contacts created: "+u(U.value.new),1)):S("",!0),U.value.updated>0?(s(),t("div",ma,"✓ Existing contacts updated: "+u(U.value.updated),1)):S("",!0),U.value.skipped>0?(s(),t("div",va," ⚠ Skipped: "+u(U.value.skipped)+" contacts (check console for details) ",1)):S("",!0)])])):(s(),t("div",ga," Error: "+u(U.value.error),1))])):S("",!0)]))])}}});export{ka as default};
