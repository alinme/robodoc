import{u as H,r as p,e as I,d as J,E as P,i as F,w as R,o as Q,c as x,a as e,j as L,l as X,F as j,b as B,v as W,t as u,f as N,D as Y,h as y}from"./index-D6DdudHB.js";import{u as Z}from"./groups-BJ29z54-.js";import{f as tt}from"./phoneValidator-nfOHmQze.js";const D="/api",et=H("calls",()=>{const h=p([]),_=p(!1),m=p(null),$=p(0),f=p({groupId:null,search:"",limit:100,offset:0});async function E(l){var c,i;_.value=!0,m.value=null;try{const n=(l==null?void 0:l.limit)??f.value.limit,r=(l==null?void 0:l.offset)??f.value.offset,o={limit:n,offset:r};f.value.groupId&&(o.groupId=f.value.groupId),f.value.search&&(o.search=f.value.search);const d=await I.get(`${D}/calls`,{params:o});h.value=(d.data.records||[]).map(g=>({...g,call_count:Number(g.call_count??0),observations:g.observations??null,last_called_at:g.last_called_at??null,last_call_type:g.last_call_type??null})),$.value=d.data.total,f.value.limit=d.data.limit??n,f.value.offset=d.data.offset??r}catch(n){m.value=((i=(c=n.response)==null?void 0:c.data)==null?void 0:i.error)||n.message,console.error("Error fetching call records:",n)}finally{_.value=!1}}async function w(l,c,i){var n,r,o;try{const d=await I.post(`${D}/calls/${l}/call`,{callType:c,observations:i??null});return k({...d.data.record,call_count:Number(((n=d.data.record)==null?void 0:n.call_count)??0)}),d.data.record}catch(d){throw new Error(((o=(r=d.response)==null?void 0:r.data)==null?void 0:o.error)||d.message)}}async function C(l,c){var i,n,r;try{const o=await I.patch(`${D}/calls/${l}`,c);return k({...o.data.record,call_count:Number(((i=o.data.record)==null?void 0:i.call_count)??0)}),o.data.record}catch(o){throw new Error(((r=(n=o.response)==null?void 0:n.data)==null?void 0:r.error)||o.message)}}function k(l){if(!l)return;const c=h.value.findIndex(i=>i.contact_id===l.contact_id);c===-1?h.value.push(l):h.value[c]=l}function b(l){f.value={...f.value,...l}}return{records:h,loading:_,error:m,total:$,filters:f,fetchRecords:E,recordCall:w,updateCallDetails:C,setFilters:b}}),at={class:"px-4 py-6 sm:px-0"},st={class:"bg-white shadow rounded-lg p-6"},lt={class:"grid gap-4 lg:grid-cols-3"},ot=["value"],nt={class:"lg:col-span-2"},it={class:"flex gap-2"},ct={class:"mt-6 bg-white shadow rounded-lg"},ut={class:"flex items-center justify-between px-6 py-4 border-b border-gray-200"},rt={class:"text-sm text-gray-500"},dt=["disabled"],pt={class:"overflow-x-auto"},vt={class:"min-w-full divide-y divide-gray-200"},ft={class:"bg-white divide-y divide-gray-100"},xt={key:0},yt={key:1},_t={class:"px-6 py-4 text-sm font-medium text-gray-900"},gt={class:"px-6 py-4 text-sm text-gray-600"},bt={class:"text-xs text-gray-400 mt-1"},ht={class:"px-6 py-4 text-sm text-gray-500"},mt={class:"px-6 py-4 text-sm text-gray-500"},wt={class:"px-6 py-4 text-sm text-gray-700"},Ct={class:"inline-flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1"},kt=["disabled","onClick"],St={class:"text-base font-semibold text-gray-900 min-w-[2rem] text-center"},$t=["disabled","onClick"],Nt={key:0,class:"mt-2 text-xs text-red-500"},Et={class:"px-6 py-4 text-sm text-gray-600"},It={key:0},Ft={key:1,class:"text-gray-400"},Lt={key:2,class:"text-xs text-gray-500 mt-1"},Dt={class:"px-6 py-4 text-sm text-gray-700"},At={class:"flex flex-col gap-2"},Tt={class:"flex gap-2"},Pt=["disabled","onClick"],Rt=["disabled","onClick"],jt=["onUpdate:modelValue"],Bt={class:"mt-2 flex items-center justify-between"},Wt=["disabled","onClick"],Gt={key:0,class:"text-xs text-green-600"},Vt={key:0,class:"mt-1 text-xs text-red-500"},Ot=J({__name:"Calls",setup(h){const _=et(),m=Z(),{records:$,loading:f}=P(_),{groups:E}=P(m),w=p(null),C=p(""),k=p(null),b=p({}),l=p({}),c=p({}),i=p({}),n=p({}),r=p({}),o=p({}),d=F(()=>$.value??[]),g=F(()=>f.value),G=F(()=>E.value??[]);function V(a){if(!a||a.length===0){b.value={};return}const s={};a.forEach(t=>{s[t.contact_id]=t.observations||""}),b.value=s}async function S(){await _.fetchRecords({offset:0})}function M(a){try{const s=new Date(a);return Number.isNaN(s.getTime())?a:s.toLocaleString()}catch{return a}}function U(a){return a.replace(/[^\d+]/g,"").replace(/^00/,"+")}function z(a){const s=a.replace(/[^\d]/g,"");if(!s)return a;let t=s;return t.startsWith("00")&&(t=t.slice(2)),t.startsWith("40")?`0${t.slice(2)}`:t.startsWith("4")?`0${t.slice(1)}`:(t.startsWith("0"),t)}function O(){k.value&&window.clearTimeout(k.value),k.value=window.setTimeout(async()=>{_.setFilters({search:C.value.trim()||"",offset:0}),await S()},400)}async function q(){w.value=null,C.value="",_.setFilters({groupId:null,search:"",offset:0}),await S()}async function A(a,s){if(n.value[a.contact_id])return;const t=Math.max(0,(a.call_count||0)+s);n.value={...n.value,[a.contact_id]:!0},r.value={...r.value,[a.contact_id]:""};try{await _.updateCallDetails(a.contact_id,{callCount:t})}catch(v){r.value={...r.value,[a.contact_id]:v.message||"Error updating counter"}}finally{n.value={...n.value,[a.contact_id]:!1}}}async function K(a){if(!l.value[a.contact_id]){l.value={...l.value,[a.contact_id]:!0},c.value={...c.value,[a.contact_id]:!1},i.value={...i.value,[a.contact_id]:""};try{await _.updateCallDetails(a.contact_id,{observations:b.value[a.contact_id]||""}),c.value={...c.value,[a.contact_id]:!0},window.setTimeout(()=>{c.value={...c.value,[a.contact_id]:!1}},1500)}catch(s){i.value={...i.value,[a.contact_id]:s.message||"Error saving observations"}}finally{l.value={...l.value,[a.contact_id]:!1}}}}async function T(a,s){if(o.value[a.contact_id])return;o.value={...o.value,[a.contact_id]:s};const t=b.value[a.contact_id]||null;try{if(await _.recordCall(a.contact_id,s,t),s==="phone"){const v=z(a.phone);window.open(`tel:${v}`,"_blank")}else{const v=U(a.phone).replace(/\+/g,"");window.open(`https://wa.me/${v}`,"_blank")}}catch(v){i.value={...i.value,[a.contact_id]:v.message||"Error recording call"}}finally{o.value={...o.value,[a.contact_id]:null},await S()}}return R(()=>$.value,a=>{V(a)},{immediate:!0}),R(w,async a=>{_.setFilters({groupId:a||null,offset:0}),await S()}),Q(async()=>{await m.fetchGroups(),await S()}),(a,s)=>(y(),x("div",at,[s[10]||(s[10]=e("div",{class:"mb-6"},[e("h2",{class:"text-3xl font-bold text-gray-900"},"Call Contacts"),e("p",{class:"mt-1 text-sm text-gray-500"}," Keep track of your phone and WhatsApp calls, update counters, and note any observations when contacts do not answer. ")],-1)),e("div",st,[e("div",lt,[e("div",null,[s[3]||(s[3]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Filter by Group",-1)),L(e("select",{"onUpdate:modelValue":s[0]||(s[0]=t=>w.value=t),class:"w-full border border-gray-300 rounded-md px-3 py-2"},[s[2]||(s[2]=e("option",{value:null},"All Groups",-1)),(y(!0),x(j,null,B(G.value,t=>(y(),x("option",{key:t.id,value:t.id},u(t.name),9,ot))),128))],512),[[X,w.value]])]),e("div",nt,[s[4]||(s[4]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Search Contacts",-1)),e("div",it,[L(e("input",{"onUpdate:modelValue":s[1]||(s[1]=t=>C.value=t),onInput:O,type:"text",placeholder:"Search by name, phone, or business",class:"flex-1 border border-gray-300 rounded-md px-3 py-2"},null,544),[[W,C.value]]),e("button",{type:"button",onClick:q,class:"px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 cursor-pointer"}," Reset ")])])])]),e("div",ct,[e("div",ut,[e("div",null,[s[5]||(s[5]=e("h3",{class:"text-lg font-medium text-gray-900"},"Contacts to Call",-1)),e("p",rt,u(d.value.length)+" contact(s) shown ",1)]),e("button",{type:"button",onClick:S,disabled:g.value,class:"px-3 py-2 text-sm bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-60 disabled:cursor-not-allowed cursor-pointer"},u(g.value?"Refreshing...":"Refresh"),9,dt)]),e("div",pt,[e("table",vt,[s[9]||(s[9]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Name"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Phone"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Group"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Business"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Counter"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Last Call"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"},"Call Actions")])],-1)),e("tbody",ft,[g.value?(y(),x("tr",xt,[...s[6]||(s[6]=[e("td",{colspan:"7",class:"px-6 py-10 text-center text-gray-500"}," Loading contacts... ",-1)])])):d.value.length===0?(y(),x("tr",yt,[...s[7]||(s[7]=[e("td",{colspan:"7",class:"px-6 py-10 text-center text-gray-500"}," No contacts found. Adjust your filters or add contacts first. ",-1)])])):N("",!0),(y(!0),x(j,null,B(d.value,t=>(y(),x("tr",{key:t.contact_id,class:"align-top"},[e("td",_t,u(t.name),1),e("td",gt,[e("div",null,u(Y(tt)(t.phone)),1),e("div",bt,u(t.phone),1)]),e("td",ht,u(t.group_name||"—"),1),e("td",mt,u(t.business||"—"),1),e("td",wt,[e("div",Ct,[e("button",{type:"button",class:"w-6 h-6 rounded-full bg-white border border-gray-300 text-gray-700 flex items-center justify-center hover:bg-gray-50 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",disabled:n.value[t.contact_id],onClick:v=>A(t,-1)}," − ",8,kt),e("span",St,u(t.call_count),1),e("button",{type:"button",class:"w-6 h-6 rounded-full bg-white border border-gray-300 text-gray-700 flex items-center justify-center hover:bg-gray-50 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",disabled:n.value[t.contact_id],onClick:v=>A(t,1)}," + ",8,$t)]),r.value[t.contact_id]?(y(),x("div",Nt,u(r.value[t.contact_id]),1)):N("",!0)]),e("td",Et,[t.last_called_at?(y(),x("div",It,u(M(t.last_called_at)),1)):(y(),x("div",Ft,"No calls yet")),t.last_call_type?(y(),x("div",Lt," Last via "+u(t.last_call_type==="whatsapp"?"WhatsApp":"Phone"),1)):N("",!0)]),e("td",Dt,[e("div",At,[e("div",Tt,[e("button",{type:"button",class:"flex-1 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer disabled:bg-green-300 disabled:cursor-not-allowed",disabled:!!o.value[t.contact_id],onClick:v=>T(t,"whatsapp")},u(o.value[t.contact_id]==="whatsapp"?"Calling...":"Call WhatsApp"),9,Pt),e("button",{type:"button",class:"flex-1 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 cursor-pointer disabled:bg-blue-300 disabled:cursor-not-allowed",disabled:!!o.value[t.contact_id],onClick:v=>T(t,"phone")},u(o.value[t.contact_id]==="phone"?"Calling...":"Call Phone"),9,Rt)]),e("div",null,[s[8]||(s[8]=e("label",{class:"block text-xs font-medium text-gray-500 mb-1"}," Observations ",-1)),L(e("textarea",{"onUpdate:modelValue":v=>b.value[t.contact_id]=v,rows:"2",class:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-green-500",placeholder:"Add notes if the contact did not answer..."},null,8,jt),[[W,b.value[t.contact_id]]]),e("div",Bt,[e("button",{type:"button",class:"px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed",disabled:l.value[t.contact_id],onClick:v=>K(t)},u(l.value[t.contact_id]?"Saving...":"Save Notes"),9,Wt),c.value[t.contact_id]?(y(),x("span",Gt," Saved ")):N("",!0)]),i.value[t.contact_id]?(y(),x("div",Vt,u(i.value[t.contact_id]),1)):N("",!0)])])])]))),128))])])])])]))}});export{Ot as default};
